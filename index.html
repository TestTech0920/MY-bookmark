<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LinkVault Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* MI File Manager / Material Design Vibes */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            -webkit-tap-highlight-color: transparent;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        /* Folder Icon Gradient */
        .folder-icon {
            background: linear-gradient(180deg, #fbbf24 0%, #d97706 100%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Youtube specific styling */
        .yt-thumbnail-container {
            position: relative;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            overflow: hidden;
            background: #000;
            border-radius: 0.5rem;
        }
        .yt-thumbnail-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Grid Layout */
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Mobile friendly small grid */
            gap: 1rem;
        }
        
        @media (min-width: 640px) {
            .grid-layout {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        /* Text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- PWA Manifest Placeholder (Would normally be an external file) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJtYW1lIjoiTGlua1ZhdWx0IiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzNiODJmNiIsImljb25zIjpbeyJzcmMiOiJodHRwczovL3ZpYS5wbGFjZWhvbGRlci5jb20vMTkyIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=" />
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 shrink-0">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-3">
                <button id="btn-back" class="p-2 rounded-full hover:bg-gray-100 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-gray-700 tracking-tight" id="header-title">LinkVault</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="app.openSearch()" class="p-2 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                </button>
                <button onclick="app.toggleMenu()" class="p-2 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Breadcrumbs -->
        <div class="px-4 py-2 bg-gray-50 border-t border-gray-200 overflow-x-auto whitespace-nowrap text-sm text-gray-500 flex items-center" id="breadcrumbs">
            <span class="text-blue-500 font-medium">Home</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 relative" id="main-container">
        <!-- Loading State -->
        <div id="loading-spinner" class="flex justify-center items-center h-full hidden">
            <div class="loader"></div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden flex flex-col items-center justify-center h-full text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mb-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 012.012 1.244l.256.512a2.25 2.25 0 002.013 1.244h3.218a2.25 2.25 0 002.013-1.244l.256-.512a2.25 2.25 0 012.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 00-2.15-1.588H6.911a2.25 2.25 0 00-2.15 1.588L2.35 13.177a2.25 2.25 0 00-.1.661z" />
            </svg>
            <p>Folder is empty</p>
        </div>

        <!-- Grid Container -->
        <div id="content-grid" class="grid-layout pb-20">
            <!-- Items injected via JS -->
        </div>
    </main>

    <!-- Floating Action Button (FAB) -->
    <div class="absolute bottom-6 right-6 z-20">
        <button onclick="app.showAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-transform active:scale-90 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </button>
    </div>

    <!-- Slide-out Menu (Settings) -->
    <div id="menu-drawer" class="fixed inset-0 bg-black/50 z-50 hidden transition-opacity" onclick="app.toggleMenu()">
        <div class="absolute right-0 top-0 bottom-0 w-64 bg-white shadow-2xl transform transition-transform translate-x-full p-4 flex flex-col" id="menu-content" onclick="event.stopPropagation()">
            <h2 class="text-lg font-bold mb-6 text-gray-800">Settings</h2>
            
            <div class="space-y-2 flex-1">
                <button onclick="app.exportData()" class="w-full text-left px-4 py-3 rounded hover:bg-gray-100 flex items-center gap-3 text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    Export Backup (JSON)
                </button>
                <button onclick="document.getElementById('import-file').click()" class="w-full text-left px-4 py-3 rounded hover:bg-gray-100 flex items-center gap-3 text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Import Backup
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="app.importData(this)">
                
                <button onclick="app.showInfo()" class="w-full text-left px-4 py-3 rounded hover:bg-gray-100 flex items-center gap-3 text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                    How to Share/Host
                </button>

                <div class="mt-6 border-t pt-4">
                    <p class="text-xs text-gray-500 mb-2">Database Usage:</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 1%" id="storage-bar"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" id="item-count">0 Items</p>
                </div>
            </div>
            <button onclick="app.toggleMenu()" class="mt-4 w-full bg-gray-200 text-gray-800 py-2 rounded">Close</button>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 sm:rounded-xl rounded-t-xl p-6 shadow-xl animate-slide-up">
            <h3 class="text-lg font-bold mb-4">Add New Item</h3>
            
            <!-- Tabs -->
            <div class="flex border-b mb-4">
                <button class="flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-medium" id="tab-link" onclick="app.switchTab('link')">Link</button>
                <button class="flex-1 py-2 text-gray-500" id="tab-folder" onclick="app.switchTab('folder')">Folder</button>
            </div>

            <div id="form-link" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                    <input type="url" id="input-url" class="w-full border rounded-lg p-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://youtube.com/...">
                </div>
                <div id="url-preview" class="hidden text-xs text-gray-500 italic">Fetching info...</div>
            </div>

            <div id="form-folder" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Folder Name</label>
                    <input type="text" id="input-folder-name" class="w-full border rounded-lg p-2 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Music, Tutorials">
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="app.closeAddModal()" class="flex-1 py-2 bg-gray-100 rounded-lg text-gray-700 font-medium">Cancel</button>
                <button onclick="app.saveItem()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Setup Guide</h3>
            
            <div class="space-y-4 text-sm text-gray-600">
                
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-1">1. How to Host (GitHub Pages)</h4>
                    <ol class="list-decimal ml-4 space-y-1">
                        <li>Create a GitHub account & new repository (e.g., "mylinks").</li>
                        <li>Upload this <code>index.html</code> file to the repository.</li>
                        <li>Go to Repo Settings -> Pages -> Select "main" branch -> Save.</li>
                        <li>Wait 1 min. You will get a URL (e.g., <code>user.github.io/mylinks</code>).</li>
                    </ol>
                </div>

                <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                    <h4 class="font-bold text-green-800 mb-1">2. Enable "Share to App" (PWA)</h4>
                    <p class="mb-2">To see this app in Android's Share menu, you need a <code>manifest.json</code> file in the same folder on GitHub.</p>
                    <button onclick="app.downloadManifest()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold shadow-sm hover:bg-green-700">Download manifest.json</button>
                    <p class="mt-2 text-xs">Upload this file next to index.html. Then on your phone, open the site -> Options -> "Add to Home Screen".</p>
                </div>

                <div>
                    <h4 class="font-bold text-gray-800">3. Data & Backup</h4>
                    <p>Data lives in your browser cache. It is <strong>not synced</strong> automatically.</p>
                    <ul class="list-disc ml-4 mt-1 space-y-1">
                        <li><strong>Transfer:</strong> Use Menu -> Export Backup to save a JSON file. Send it to your new device and Import.</li>
                        <li><strong>Reset:</strong> Clearing browser cache will delete your links unless backed up!</li>
                    </ul>
                </div>

            </div>
            <button onclick="app.closeInfo()" class="mt-6 w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900">Close Guide</button>
        </div>
    </div>

    <script>
        /**
         * DATABASE LAYER (IndexedDB)
         * Handles storage of potentially lakhs of records.
         */
        const DB_NAME = 'LinkVaultDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'items';

        const dbService = {
            db: null,
            
            async connect() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            store.createIndex('parentId', 'parentId', { unique: false });
                            store.createIndex('type', 'type', { unique: false });
                            store.createIndex('createdAt', 'createdAt', { unique: false });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };

                    request.onerror = (event) => {
                        console.error("DB Error", event);
                        reject('Database error');
                    };
                });
            },

            async addItem(item) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([STORE_NAME], 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.add(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },

            async getItemsByParent(parentId) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([STORE_NAME], 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const index = store.index('parentId');
                    const request = index.getAll(parentId); // Fetch all items in folder
                    
                    request.onsuccess = () => {
                        // Sort: Folders first, then by date descending
                        const items = request.result;
                        items.sort((a, b) => {
                            if (a.type === b.type) {
                                return b.createdAt - a.createdAt; // Newest first
                            }
                            return a.type === 'folder' ? -1 : 1; // Folders first
                        });
                        resolve(items);
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            async deleteItem(id) {
                // Note: If folder, ideally recursive delete. For simplicity, we delete just the item.
                // Advanced: Check if folder and delete children.
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([STORE_NAME], 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    store.delete(id).onsuccess = () => resolve();
                });
            },

            async getBreadcrumbs(parentId) {
                // Recursively climb up to build breadcrumbs
                const crumbs = [];
                let currentId = parentId;
                
                while (currentId !== 'root') {
                    const item = await new Promise((resolve) => {
                        const tx = this.db.transaction([STORE_NAME], 'readonly');
                        tx.objectStore(STORE_NAME).get(currentId).onsuccess = (e) => resolve(e.target.result);
                    });
                    if (item) {
                        crumbs.unshift({ id: item.id, name: item.title });
                        currentId = item.parentId;
                    } else {
                        break; 
                    }
                }
                crumbs.unshift({ id: 'root', name: 'Home' });
                return crumbs;
            },

            async search(query) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction([STORE_NAME], 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.openCursor();
                    const results = [];
                    const lowerQ = query.toLowerCase();

                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.title.toLowerCase().includes(lowerQ)) {
                                results.push(cursor.value);
                            }
                            // Limit search results for performance if needed
                            if (results.length < 100) cursor.continue();
                        } else {
                            resolve(results);
                        }
                    };
                });
            },

            async exportAll() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction([STORE_NAME], 'readonly');
                    tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => resolve(e.target.result);
                });
            },

            async importAll(data) {
                const tx = this.db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                // Clear existing? Optional. Let's merge/overwrite based on ID
                data.forEach(item => {
                    store.put(item);
                });
                return new Promise((resolve) => {
                    tx.oncomplete = () => resolve();
                });
            },
            
            async countItems() {
                return new Promise(resolve => {
                     const tx = this.db.transaction([STORE_NAME], 'readonly');
                     tx.objectStore(STORE_NAME).count().onsuccess = (e) => resolve(e.target.result);
                });
            }
        };

        /**
         * APPLICATION LOGIC
         */
        const app = {
            currentFolder: 'root',
            activeTab: 'link', // link | folder

            async init() {
                try {
                    await dbService.connect();
                    this.renderFolder(this.currentFolder);
                    this.updateStats();
                    this.checkSharedParams();
                } catch (e) {
                    console.error("Failed to init", e);
                    alert("Database failed to open. Please use a modern browser.");
                }
            },
            
            checkSharedParams() {
                // Check if opened via Share Target (URL Params)
                const params = new URLSearchParams(window.location.search);
                const title = params.get('title');
                const text = params.get('text');
                const url = params.get('url');
                
                if (title || text || url) {
                    // If text contains a URL, extract it
                    let finalUrl = url || text; 
                    // Simple regex to find URL in text
                    if (text && !url) {
                        const match = text.match(/(https?:\/\/[^\s]+)/g);
                        if (match) finalUrl = match[0];
                    }

                    if (finalUrl) {
                        this.showAddModal();
                        document.getElementById('input-url').value = finalUrl;
                        // Clean URL params so we don't add again on refresh
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            },

            async renderFolder(folderId) {
                this.currentFolder = folderId;
                const grid = document.getElementById('content-grid');
                const loading = document.getElementById('loading-spinner');
                const empty = document.getElementById('empty-state');
                
                grid.innerHTML = '';
                loading.classList.remove('hidden');
                empty.classList.add('hidden');

                // Update Back Button
                const btnBack = document.getElementById('btn-back');
                if (folderId !== 'root') {
                    btnBack.classList.remove('hidden');
                    btnBack.onclick = async () => {
                        // Find parent of current folder
                        // Since we don't store parent ref in memory, we query breadcrumbs
                        const crumbs = await dbService.getBreadcrumbs(folderId);
                        if (crumbs.length >= 2) {
                            this.renderFolder(crumbs[crumbs.length - 2].id);
                        } else {
                            this.renderFolder('root');
                        }
                    };
                } else {
                    btnBack.classList.add('hidden');
                }

                // Render Breadcrumbs
                const crumbs = await dbService.getBreadcrumbs(folderId);
                const breadContainer = document.getElementById('breadcrumbs');
                breadContainer.innerHTML = crumbs.map((c, index) => {
                    const isLast = index === crumbs.length - 1;
                    const color = isLast ? 'text-gray-800 font-bold' : 'text-blue-500 cursor-pointer';
                    const event = isLast ? '' : `onclick="app.renderFolder('${c.id}')"`;
                    return `<span class="${color} mx-1" ${event}>${c.name}</span> ${!isLast ? '<span class="text-gray-400">/</span>' : ''}`;
                }).join('');

                // Get Items
                const items = await dbService.getItemsByParent(folderId);
                loading.classList.add('hidden');

                if (items.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }

                // Render Items
                // Use DocumentFragment for performance
                const frag = document.createDocumentFragment();
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col gap-2 p-2 rounded-lg hover:bg-white hover:shadow-sm transition-all cursor-pointer group relative';
                    
                    if (item.type === 'folder') {
                        el.onclick = () => this.renderFolder(item.id);
                        el.innerHTML = `
                            <div class="w-full aspect-[4/3] folder-icon rounded-lg flex items-center justify-center relative">
                                <svg class="w-12 h-12 text-white/90 drop-shadow-md" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                                </svg>
                            </div>
                            <span class="text-xs text-center font-medium text-gray-700 truncate px-1">${item.title}</span>
                        `;
                    } else {
                        // Link
                        el.onclick = () => window.open(item.url, '_blank');
                        el.innerHTML = `
                            <div class="yt-thumbnail-container bg-gray-200">
                                <img src="${item.thumbnail || 'https://via.placeholder.com/300x200?text=No+Img'}" loading="lazy" alt="">
                                <div class="absolute bottom-1 right-1 bg-black/70 text-white text-[10px] px-1 rounded">
                                    ${item.platform}
                                </div>
                            </div>
                            <span class="text-xs font-medium text-gray-800 line-clamp-2 leading-tight h-8">${item.title}</span>
                        `;
                    }

                    // Delete Button (Long press or hover)
                    const delBtn = document.createElement('button');
                    delBtn.className = 'absolute top-1 right-1 bg-white/90 text-red-500 p-1 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity sm:block';
                    // On Mobile, maybe show always? Or add a selection mode. 
                    // For simplicity: Show on hover/focus.
                    delBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if(confirm(`Delete "${item.title}"?`)) {
                            dbService.deleteItem(item.id).then(() => this.renderFolder(this.currentFolder));
                            this.updateStats();
                        }
                    };
                    
                    el.appendChild(delBtn);
                    frag.appendChild(el);
                });

                grid.appendChild(frag);
            },

            // --- Modal & Form Logic ---

            showAddModal() {
                document.getElementById('add-modal').classList.remove('hidden');
                document.getElementById('input-url').focus();
            },

            closeAddModal() {
                document.getElementById('add-modal').classList.add('hidden');
                document.getElementById('input-url').value = '';
                document.getElementById('input-folder-name').value = '';
            },

            switchTab(tab) {
                this.activeTab = tab;
                const linkForm = document.getElementById('form-link');
                const folderForm = document.getElementById('form-folder');
                const linkTab = document.getElementById('tab-link');
                const folderTab = document.getElementById('tab-folder');

                if (tab === 'link') {
                    linkForm.classList.remove('hidden');
                    folderForm.classList.add('hidden');
                    linkTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                    linkTab.classList.remove('text-gray-500');
                    folderTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    folderTab.classList.add('text-gray-500');
                } else {
                    linkForm.classList.add('hidden');
                    folderForm.classList.remove('hidden');
                    folderTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                    folderTab.classList.remove('text-gray-500');
                    linkTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    linkTab.classList.add('text-gray-500');
                }
            },

            async saveItem() {
                const id = Date.now().toString();
                const createdAt = Date.now();

                if (this.activeTab === 'folder') {
                    const name = document.getElementById('input-folder-name').value.trim();
                    if (!name) return alert("Name required");
                    
                    await dbService.addItem({
                        id,
                        parentId: this.currentFolder,
                        type: 'folder',
                        title: name,
                        createdAt
                    });
                } else {
                    let url = document.getElementById('input-url').value.trim();
                    if (!url) return alert("URL required");

                    // FIX: Auto-add protocol if missing to prevent "Blocked" errors
                    if (!/^https?:\/\//i.test(url)) {
                        url = 'https://' + url;
                    }

                    // Fetch Metadata
                    const metadata = await this.fetchMetadata(url);
                    
                    await dbService.addItem({
                        id,
                        parentId: this.currentFolder,
                        type: 'link',
                        title: metadata.title || url,
                        url: url,
                        thumbnail: metadata.thumbnail,
                        platform: metadata.platform,
                        createdAt
                    });
                }

                this.closeAddModal();
                this.renderFolder(this.currentFolder);
                this.updateStats();
            },

            async fetchMetadata(url) {
                let title = '';
                let thumbnail = '';
                let platform = 'Web';

                // Youtube Detection
                const ytRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const ytMatch = url.match(ytRegex);

                if (ytMatch) {
                    const videoId = ytMatch[1];
                    platform = 'YouTube';
                    // High Quality thumb
                    thumbnail = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                    
                    // Try to get title via noembed (CORS friendly usually)
                    try {
                        const response = await fetch(`https://noembed.com/embed?url=${url}`);
                        const data = await response.json();
                        if (data.title) title = data.title;
                    } catch (e) {
                        console.log("Title fetch failed");
                    }
                } else {
                    // Generic Favicon/Domain attempt
                    try {
                         const domain = new URL(url).hostname;
                         thumbnail = `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
                         platform = domain.replace('www.','');
                    } catch(e) {}
                }

                return { title, thumbnail, platform };
            },

            // --- Settings & Data Management ---

            toggleMenu() {
                const drawer = document.getElementById('menu-drawer');
                const content = document.getElementById('menu-content');
                
                if (drawer.classList.contains('hidden')) {
                    drawer.classList.remove('hidden');
                    // Slight delay for animation
                    setTimeout(() => {
                        content.classList.remove('translate-x-full');
                    }, 10);
                } else {
                    content.classList.add('translate-x-full');
                    setTimeout(() => {
                        drawer.classList.add('hidden');
                    }, 300);
                }
            },

            async exportData() {
                const data = await dbService.exportAll();
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bookmarks_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                this.toggleMenu();
            },

            async importData(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error("Invalid Format");
                        
                        if(confirm(`Import ${data.length} items? This will merge with existing data.`)) {
                             await dbService.importAll(data);
                             alert("Import Successful!");
                             this.renderFolder(this.currentFolder);
                             this.updateStats();
                        }
                    } catch (err) {
                        alert("Failed to parse file");
                    }
                    this.toggleMenu();
                };
                reader.readAsText(file);
            },
            
            async updateStats() {
                const count = await dbService.countItems();
                document.getElementById('item-count').innerText = `${count} Items`;
                // Fake bar for visual
                const width = Math.min(100, (count / 10000) * 100);
                document.getElementById('storage-bar').style.width = `${Math.max(1, width)}%`;
            },
            
            openSearch() {
                const q = prompt("Search bookmarks:");
                if(q) {
                    this.performSearch(q);
                }
            },
            
            async performSearch(query) {
                 const results = await dbService.search(query);
                 
                 const grid = document.getElementById('content-grid');
                 grid.innerHTML = '';
                 document.getElementById('breadcrumbs').innerHTML = `<span class="text-gray-800 font-bold mx-1">Search Results: "${query}"</span>`;
                 document.getElementById('btn-back').classList.remove('hidden');
                 document.getElementById('btn-back').onclick = () => this.renderFolder('root');
                 
                 if(results.length === 0) {
                     document.getElementById('empty-state').classList.remove('hidden');
                     return;
                 }
                 document.getElementById('empty-state').classList.add('hidden');
                 
                 // Render basic results (Similar logic to renderFolder, simplified)
                 const frag = document.createDocumentFragment();
                 results.forEach(item => {
                     const el = document.createElement('div');
                     el.className = 'flex flex-col gap-2 p-2 rounded-lg hover:bg-white cursor-pointer';
                     // For simplicity in search, just show list items
                     el.innerHTML = `
                        <div class="bg-white p-2 rounded shadow-sm flex gap-2 items-center">
                             <div class="w-10 h-10 bg-gray-200 shrink-0 rounded overflow-hidden">
                                 ${item.type === 'folder' ? '<div class="w-full h-full bg-yellow-500"></div>' : `<img src="${item.thumbnail}" class="w-full h-full object-cover">`}
                             </div>
                             <div class="overflow-hidden">
                                 <div class="text-sm font-bold truncate">${item.title}</div>
                                 <div class="text-xs text-gray-500 truncate">${item.url || 'Folder'}</div>
                             </div>
                        </div>
                     `;
                     el.onclick = () => {
                         if(item.type === 'folder') this.renderFolder(item.id);
                         else window.open(item.url, '_blank');
                     };
                     frag.appendChild(el);
                 });
                 grid.appendChild(frag);
            },

            showInfo() {
                document.getElementById('info-modal').classList.remove('hidden');
            },
            closeInfo() {
                document.getElementById('info-modal').classList.add('hidden');
            },
            
            downloadManifest() {
                const manifest = {
                    "name": "LinkVault",
                    "short_name": "LinkVault",
                    "start_url": "./index.html",
                    "display": "standalone",
                    "background_color": "#ffffff",
                    "theme_color": "#3b82f6",
                    "icons": [
                        {
                            "src": "https://via.placeholder.com/192/3b82f6/ffffff?text=LV",
                            "sizes": "192x192",
                            "type": "image/png"
                        },
                        {
                            "src": "https://via.placeholder.com/512/3b82f6/ffffff?text=LV",
                            "sizes": "512x512",
                            "type": "image/png"
                        }
                    ],
                    "share_target": {
                        "action": "./index.html",
                        "method": "GET",
                        "enctype": "application/x-www-form-urlencoded",
                        "params": {
                            "title": "title",
                            "text": "text",
                            "url": "url"
                        }
                    }
                };
                
                const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'manifest.json';
                a.click();
            }
        };

        // Init
        window.onload = () => app.init();

    </script>
</body>
</html>
