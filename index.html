<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mani's Bookmark Vault</title>
  <meta name="description" content="Personal bookmark manager with clipboard capture, GitHub sync, share target, and offline-ready storage.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230f172a'/><path d='M25 25h50v50L50 60 25 75Z' fill='%23ffca3a'/></svg>">
  <meta name="theme-color" content="#ffca3a">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=General+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600&display=swap');
    :root {
      color-scheme: light;
    }
    * {
      font-family: "General Sans", "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #fff7d6 0%, #ffe7c6 35%, #f7f0ff 70%, #dbe8ff 100%);
      transition: background 0.5s ease, color 0.5s ease;
      color: #0f172a;
    }
    body[data-theme="midnight"] {
      background: radial-gradient(circle at top, #090915 0%, #111327 45%, #0b132b 100%);
      color: #f5f7ff;
    }
    body[data-theme="neon"] {
      background: radial-gradient(circle at top, #030014 0%, #10002b 40%, #240046 70%, #36005c 100%);
      color: #f3f6ff;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.08);
    }
    body[data-theme="glass"] {
      background: linear-gradient(135deg, #e8f0ff 0%, #fef6ff 35%, #e9fffb 65%, #fefde1 100%);
      color: #0f172a;
    }
    body.modal-open {
      overflow: hidden;
    }
    input, select, textarea {
      color: inherit;
      background: rgba(255, 255, 255, 0.95);
    }
    input::placeholder,
    textarea::placeholder {
      color: #94a3b8;
    }
    body[data-theme="midnight"] input,
    body[data-theme="midnight"] select,
    body[data-theme="midnight"] textarea,
    body[data-theme="neon"] input,
    body[data-theme="neon"] select,
    body[data-theme="neon"] textarea {
      background: rgba(8, 10, 24, 0.65);
      border-color: rgba(255, 255, 255, 0.15);
      color: #f5f7ff;
    }
    .glass-panel {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(18px);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.15);
    }
    body[data-theme="midnight"] .glass-panel {
      background: rgba(7, 10, 23, 0.82);
      border-color: rgba(255, 255, 255, 0.08);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.55);
    }
    body[data-theme="neon"] .glass-panel {
      background: rgba(8, 9, 26, 0.78);
      border-color: rgba(80, 255, 218, 0.4);
      box-shadow: 0 30px 60px rgba(80, 255, 218, 0.2);
    }
    body[data-theme="glass"] .glass-panel {
      background: rgba(255, 255, 255, 0.55);
      border-color: rgba(15, 23, 42, 0.08);
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.08);
    }
    header .actions button {
      transition: transform 0.2s ease;
    }
    header .actions button:hover {
      transform: translateY(-1px);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.78rem;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.7);
      color: #111;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }
    body[data-theme="midnight"] .badge,
    body[data-theme="neon"] .badge {
      background: rgba(255, 255, 255, 0.1);
      color: #f5f5f5;
    }
    .platform-chip {
      cursor: pointer;
      border-radius: 18px;
      padding: 0.55rem 0.95rem;
      border: 1px solid transparent;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      background: rgba(255, 255, 255, 0.7);
    }
    .platform-chip.active {
      border-color: rgba(15, 23, 42, 0.2);
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-2px);
    }
    body[data-theme="midnight"] .platform-chip,
    body[data-theme="neon"] .platform-chip {
      background: rgba(255, 255, 255, 0.05);
      color: #f5f5f5;
      border-color: rgba(255, 255, 255, 0.1);
    }
    .bookmark-card {
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.92);
    }
    body[data-theme="midnight"] .bookmark-card,
    body[data-theme="neon"] .bookmark-card {
      border-color: rgba(255, 255, 255, 0.06);
      background: rgba(9, 13, 29, 0.95);
    }
    .bookmark-thumb {
      width: 78px;
      height: 78px;
      border-radius: 18px;
      object-fit: cover;
      background: #e8ecf5;
      border: 1px solid rgba(15, 23, 42, 0.08);
      flex-shrink: 0;
    }
    body[data-theme="midnight"] .bookmark-thumb,
    body[data-theme="neon"] .bookmark-thumb {
      background: #1f2940;
      border-color: rgba(255, 255, 255, 0.05);
    }
    .bookmark-index {
      font-weight: 600;
      letter-spacing: 0.08em;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .section-toggle {
      width: 2.75rem;
      height: 2.75rem;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.15);
      background: rgba(255, 255, 255, 0.8);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    body[data-theme="midnight"] .section-toggle,
    body[data-theme="neon"] .section-toggle {
      border-color: rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.08);
      color: #f5f5f5;
    }
    .section-toggle .toggle-icon {
      font-weight: 600;
    }
    .collapsible-body {
      margin-top: 1.5rem;
    }
    [data-collapsible].is-collapsed .collapsible-body {
      display: none;
    }
    .library-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .library-tabs button {
      flex: 1;
      min-width: 140px;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      background: rgba(15, 23, 42, 0.06);
      border: 1px solid transparent;
      font-weight: 500;
      font-size: 0.9rem;
      transition: background 0.2s ease;
    }
    .library-tabs button.active {
      background: #0f172a;
      color: #fff;
    }
    body[data-theme="midnight"] .library-tabs button,
    body[data-theme="neon"] .library-tabs button {
      background: rgba(255, 255, 255, 0.08);
      color: #cbd5f5;
    }
    body[data-theme="midnight"] .library-tabs button.active,
    body[data-theme="neon"] .library-tabs button.active {
      background: #ffca3a;
      color: #0f172a;
    }
    .library-panel.hidden {
      display: none;
    }
    .snippet-card,
    .image-card {
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.92);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }
    body[data-theme="midnight"] .snippet-card,
    body[data-theme="midnight"] .image-card,
    body[data-theme="neon"] .snippet-card,
    body[data-theme="neon"] .image-card {
      border-color: rgba(255, 255, 255, 0.06);
      background: rgba(9, 13, 29, 0.95);
    }
    .image-card img {
      border-radius: 14px;
      width: 100%;
      object-fit: cover;
      max-height: 320px;
      background: #e4e7ee;
    }
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(15, 23, 42, 0.25);
      border-radius: 999px;
    }
    body[data-theme="midnight"] ::-webkit-scrollbar-thumb,
    body[data-theme="neon"] ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.25);
    }
    .clipboard-modal {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 50;
    }
    .clipboard-modal.hidden {
      display: none;
    }
    .clipboard-card {
      max-width: 480px;
      width: 100%;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.95);
      padding: 1.5rem;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 30px 60px rgba(2, 6, 23, 0.35);
    }
    body[data-theme="midnight"] .clipboard-card,
    body[data-theme="neon"] .clipboard-card {
      background: rgba(9, 13, 29, 0.95);
      color: #f5f7ff;
      border-color: rgba(255, 255, 255, 0.1);
    }
    #primaryWorkspace {
      display: grid;
      gap: 1.5rem;
    }
    #addBookmarkSection {
      order: 1;
    }
    #librarySection {
      order: 2;
    }
    @media (min-width: 1024px) {
      #primaryWorkspace {
        grid-template-columns: minmax(0, 1.25fr) minmax(0, 1fr);
        align-items: start;
      }
    }
    .bookmark-meta {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #475569;
    }
    body[data-theme="midnight"] .bookmark-meta,
    body[data-theme="neon"] .bookmark-meta {
      color: #cbd5f5;
    }
    .bookmark-row {
      display: flex;
      gap: 1rem;
    }
    .quick-grid {
      display: grid;
      gap: 1.5rem;
    }
    @media (min-width: 1024px) {
      .quick-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .autocomplete-panel {
      box-shadow: 0 20px 30px rgba(15, 23, 42, 0.15);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.98);
    }
    body[data-theme="midnight"] .autocomplete-panel {
      background: rgba(7, 10, 23, 0.95);
      border-color: rgba(255, 255, 255, 0.08);
      color: #f5f5f5;
    }
    .autocomplete-item {
      padding: 0.55rem 0.85rem;
      font-size: 0.85rem;
      text-align: left;
      width: 100%;
    }
    .autocomplete-item:hover {
      background: rgba(15, 23, 42, 0.05);
    }
    body[data-theme="midnight"] .autocomplete-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    #toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.8rem 1.2rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      color: #fff;
      font-size: 0.85rem;
      box-shadow: 0 15px 35px rgba(15, 23, 42, 0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 60;
      pointer-events: none;
    }
    body[data-theme="midnight"] #toast,
    body[data-theme="neon"] #toast {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    #toast.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body data-theme="sunrise">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6" id="appShell">
    <header class="glass-panel rounded-3xl p-6 space-y-4">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <p class="badge">Clipboard smart-capture · Local JSON</p>
          <h1 class="text-3xl sm:text-4xl font-semibold text-slate-900 dark:text-white mt-2">Mani's Bookmark Vault</h1>
          <p class="text-slate-700 dark:text-slate-200 max-w-2xl mt-2">Save anything you copy or share — links, notes, and reference images — categorize instantly, and sync privately. Full clipboard prompts, folder rails, and dedicated tabs keep every medium neat.</p>
        </div>
        <div class="actions flex flex-wrap items-center gap-3">
          <button id="saveEntryTop" class="px-4 py-2 rounded-2xl border border-white/60 bg-white/80 text-slate-900 font-medium shadow-sm">Add bookmark</button>
          <button id="clipboardCheck" class="px-4 py-2 rounded-2xl border border-slate-200 bg-white/70 text-slate-900 font-medium shadow-sm">Capture clipboard</button>
          <button id="themeToggle" class="px-4 py-2 rounded-2xl border border-white/40 bg-white/70 text-slate-900 font-medium shadow-sm">
            Theme: Sunrise
          </button>
          <button id="installPwaBtn" class="px-4 py-2 rounded-2xl border border-amber-200 bg-amber-100 text-amber-900 font-medium shadow-sm disabled:opacity-50" disabled>
            Install App
          </button>
        </div>
      </div>
      <div class="flex flex-wrap gap-3 text-xs uppercase tracking-wide">
        <span class="badge">PWA Ready</span>
        <span class="badge">Neon & Glass themes</span>
        <span class="badge">GitHub Sync</span>
        <span class="badge">Clipboard intake</span>
      </div>
      <div class="toggle-controls flex flex-wrap gap-3">
        <button id="expandAll" type="button" class="px-4 py-2 rounded-2xl border border-slate-200 bg-white/80 text-sm font-medium">Expand all</button>
        <button id="collapseAll" type="button" class="px-4 py-2 rounded-2xl border border-slate-200 bg-white/80 text-sm font-medium">Collapse all</button>
      </div>
    </header>

    <section class="glass-panel rounded-3xl p-5" id="platformSection" data-collapsible>
      <div class="section-header">
        <div>
          <h2 class="text-xl font-semibold">Platform rails</h2>
          <p class="text-sm text-slate-500">Tap a chip to focus on a source. Counts adapt instantly.</p>
        </div>
        <div class="flex gap-3 items-center">
          <button id="clearFilters" class="text-sm text-slate-500 hover:text-slate-900 dark:hover:text-white">Reset filters</button>
          <button type="button" class="section-toggle" data-toggle aria-label="Expand section">
            <span class="toggle-icon">+</span>
          </button>
        </div>
      </div>
      <div class="collapsible-body">
        <div id="platformRail" class="flex flex-wrap gap-3"></div>
      </div>
    </section>

    <section id="primaryWorkspace">
      <section id="addBookmarkSection" class="glass-panel rounded-3xl p-5" data-collapsible data-default-open>
        <div class="section-header">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-500">Auto-fetch thumbnails & metadata</p>
            <h2 class="text-xl font-semibold">Add bookmark</h2>
          </div>
          <button type="button" class="section-toggle" data-toggle aria-label="Collapse section">
            <span class="toggle-icon">−</span>
          </button>
        </div>
        <div class="collapsible-body">
          <form id="bookmarkForm" class="space-y-4">
            <div class="flex justify-end">
              <button type="submit" class="rounded-2xl bg-slate-900 text-white px-5 py-2 text-sm font-semibold hover:bg-slate-800 transition">Save entry</button>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200">Platform
                <select name="platform" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3 text-slate-900" required>
                  <option>YouTube</option>
                  <option>Article</option>
                  <option>Podcast</option>
                  <option>Tweet</option>
                  <option>Custom</option>
                </select>
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200">Folder
                <input name="folder" list="folderOptions" placeholder="e.g. Inspiration" value="AI" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3" required>
                <datalist id="folderOptions"></datalist>
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200 sm:col-span-2">URL
                <input name="url" id="urlInput" type="url" placeholder="https://" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3">
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200">Title (optional override)
                <input name="title" placeholder="Auto-detected if empty" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3">
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200">Tags
                <input name="tags" placeholder="comma,separated" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3">
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200 sm:col-span-2">Notes
                <textarea name="notes" rows="2" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3" placeholder="Context, highlights, tasks..."></textarea>
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200">Text title
                <input name="textTitle" placeholder="e.g. Launch checklist" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3">
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200">Image title
                <input name="imageTitle" placeholder="e.g. Mood board" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3">
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200 sm:col-span-2">Text snippet (stored separately)
                <textarea name="textSnippet" rows="2" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3" placeholder="Paste transcript, summary, or raw text."></textarea>
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200 sm:col-span-2">Reference image upload
                <input name="image" type="file" accept="image/*" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3">
              </label>
              <label class="text-sm font-medium text-slate-600 dark:text-slate-200 sm:col-span-2">Reference image URL (fetches from other websites)
                <input name="imageUrl" type="url" placeholder="https://example.com/shot.png" class="mt-1 w-full rounded-2xl border border-slate-200 bg-white/80 p-3">
              </label>
            </div>
            <button type="submit" class="w-full rounded-2xl bg-slate-900 text-white py-3 font-semibold hover:bg-slate-800 transition">
              Save entry
            </button>
            <p class="text-xs text-slate-500">Paste a YouTube link and the app fetches its title + thumbnail. Clipboard capture can pre-fill these fields automatically.</p>
          </form>
        </div>
      </section>

      <section class="glass-panel rounded-3xl p-5" id="librarySection" data-collapsible data-default-open>
        <div class="section-header">
          <div>
            <h2 class="text-xl font-semibold">Library</h2>
            <p class="text-sm text-slate-500">Search filters bookmarks, snippets, and images simultaneously.</p>
          </div>
          <button type="button" class="section-toggle" data-toggle aria-label="Collapse section">
            <span class="toggle-icon">−</span>
          </button>
        </div>
        <div class="collapsible-body space-y-4">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <p class="text-sm text-slate-500">Type anything to filter site names, tags, notes, snippets, or image titles.</p>
            <div class="relative w-full sm:w-72">
              <input id="searchInput" list="searchSuggestions" type="search" placeholder="Search bookmarks · text · images" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 w-full">
              <datalist id="searchSuggestions"></datalist>
              <div id="searchAutocomplete" class="autocomplete-panel absolute top-full left-0 right-0 mt-1 hidden z-10 max-h-52 overflow-auto"></div>
            </div>
          </div>
          <div class="library-tabs" id="libraryTabs">
            <button type="button" class="active" data-library-tab="bookmarks">Bookmarks</button>
            <button type="button" data-library-tab="snippets">Text snippets</button>
            <button type="button" data-library-tab="images">Reference images</button>
          </div>
          <div class="library-panel" data-tab-panel="bookmarks">
            <div id="bookmarkGrid" class="grid gap-4"></div>
            <p id="emptyState" class="text-center text-sm text-slate-500 hidden">Start saving! Your bookmarks will appear here.</p>
            <div id="bookmarkPagination" class="flex flex-wrap items-center justify-between gap-3 text-xs text-slate-500 mt-3 hidden">
              <span id="paginationInfo" class="font-medium"></span>
              <div class="flex gap-2">
                <button id="prevPage" class="rounded-2xl border border-slate-200 bg-white/70 px-3 py-1.5 disabled:opacity-50">‹ Prev</button>
                <button id="nextPage" class="rounded-2xl border border-slate-200 bg-white/70 px-3 py-1.5 disabled:opacity-50">Next ›</button>
              </div>
            </div>
          </div>
          <div class="library-panel hidden" data-tab-panel="snippets">
            <div id="snippetList" class="space-y-3"></div>
            <p id="snippetEmpty" class="text-center text-sm text-slate-500">No text snippets captured yet.</p>
          </div>
          <div class="library-panel hidden" data-tab-panel="images">
            <div id="imageGrid" class="grid gap-4 sm:grid-cols-2"></div>
            <p id="imageEmpty" class="text-center text-sm text-slate-500">No reference images stored yet.</p>
          </div>
        </div>
      </section>
    </section>

    <div class="quick-grid">
      <div class="space-y-4">
        <section id="quickActionsSection" class="glass-panel rounded-3xl p-5" data-collapsible>
          <div class="section-header">
            <h3 class="font-semibold">Quick actions</h3>
            <button type="button" class="section-toggle" data-toggle aria-label="Expand section">
              <span class="toggle-icon">+</span>
            </button>
          </div>
          <div class="collapsible-body space-y-3">
            <div class="flex flex-wrap gap-3">
              <button id="exportBtn" class="flex-1 rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 text-sm font-medium">Export JSON</button>
              <label class="flex-1 rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 text-sm font-medium text-center cursor-pointer">Import JSON
                <input id="importInput" type="file" accept="application/json" class="hidden">
              </label>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-200">Use import/export when migrating or sharing your vault offline.</p>
            <div class="rounded-2xl border border-dashed border-slate-300 p-3 text-xs text-slate-500">
              <p class="font-semibold text-slate-700 dark:text-white">Share Target ready</p>
              <p>Install the PWA once, then share links, text, or images from any app directly into Mani's Vault. Android sends data via the built-in share sheet.</p>
            </div>
          </div>
        </section>

        <section id="foldersSection" class="glass-panel rounded-3xl p-5" data-collapsible>
          <div class="section-header">
            <div>
              <h3 class="font-semibold">Folders</h3>
              <span id="folderCount" class="text-xs text-slate-500">0 folders</span>
            </div>
            <button type="button" class="section-toggle" data-toggle aria-label="Expand section">
              <span class="toggle-icon">+</span>
            </button>
          </div>
          <div class="collapsible-body">
            <div id="folderList" class="flex flex-wrap gap-2"></div>
          </div>
        </section>
      </div>

      <section id="syncHub" class="glass-panel rounded-3xl p-5 lg:col-span-2" data-collapsible>
        <div class="section-header">
          <div>
            <h2 class="text-xl font-semibold">GitHub Sync & Private vaults</h2>
            <p class="text-sm text-slate-500">Sync your JSON archive to GitHub (supports private repositories with a token that has <code>repo</code> scope).</p>
          </div>
          <button type="button" class="section-toggle" data-toggle aria-label="Expand section">
            <span class="toggle-icon">+</span>
          </button>
        </div>
        <div class="collapsible-body space-y-4">
          <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
            <input id="githubOwner" placeholder="Owner / Org" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2">
            <input id="githubRepo" placeholder="Repository" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2">
            <input id="githubPath" placeholder="Path e.g. data/bookmarks.json" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2">
            <input id="githubToken" type="password" placeholder="Personal Access Token" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2">
          </div>
          <div class="flex flex-wrap gap-3">
            <button id="pullGithub" class="flex-1 rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 font-medium">Pull from GitHub</button>
            <button id="pushGithub" class="flex-1 rounded-2xl bg-slate-900 text-white px-4 py-2 font-semibold">Push to GitHub</button>
          </div>
          <p id="githubStatus" class="text-sm text-slate-500">Status: idle</p>
        </div>
      </section>
    </div>

    <section class="glass-panel rounded-3xl p-5 space-y-6" data-collapsible>
      <div class="section-header">
        <h2 class="text-xl font-semibold">Deployment, Sync & Cross-app sharing guide</h2>
        <button type="button" class="section-toggle" data-toggle aria-label="Expand section">
          <span class="toggle-icon">+</span>
        </button>
      </div>
      <div class="collapsible-body space-y-6 text-sm text-slate-600 dark:text-slate-200">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="rounded-2xl border border-slate-200/60 p-4 space-y-2">
            <h3 class="font-semibold">GitHub Pages deployment — detailed</h3>
            <ol class="list-decimal list-inside space-y-1">
              <li><strong>Repo setup:</strong> create a new GitHub repo and add this <code>index.html</code>. Commit + push to <code>main</code>.</li>
              <li><strong>Enable Pages:</strong> Settings → Pages → Build & deployment → select <em>Deploy from branch</em>, branch <code>main</code>, folder <code>/</code>.</li>
              <li><strong>HTTPS testing:</strong> wait ~1 minute, then visit the Pages URL on mobile. The install banner enables PWA + share target prompts.</li>
              <li><strong>Optional seed data:</strong> upload a <code>data/bookmarks.json</code> exported from the app to pre-fill new visitors.</li>
              <li><strong>One-file deploy:</strong> everything (styles, manifest, SW) is inline, so a single <code>index.html</code> is enough.</li>
            </ol>
          </div>
          <div class="rounded-2xl border border-slate-200/60 p-4 space-y-2">
            <h3 class="font-semibold">GitHub sync — push/pull workflow</h3>
            <ol class="list-decimal list-inside space-y-1">
              <li>Generate a classic Personal Access Token with <code>repo</code> scope (Settings → Developer settings → PATs).</li>
              <li>Fill Owner, Repo, Path (e.g. <code>vault/bookmarks.json</code>) and paste the token into the Sync card.</li>
              <li><strong>Push</strong>: serializes localStorage data, Base64 encodes it, and updates/creates the GitHub file (keeps SHA so history is preserved).</li>
              <li><strong>Pull</strong>: downloads JSON from GitHub, replaces your local vault, and re-renders. Always export a backup first.</li>
              <li>For private repos, ensure the token user has write access. Revoke tokens if the device is lost.</li>
            </ol>
          </div>
        </div>
        <div class="rounded-2xl border border-slate-200/60 p-4 space-y-2">
          <h3 class="font-semibold">Share links, text, or images from any app</h3>
          <ul class="list-disc list-inside space-y-1">
            <li><strong>Install once:</strong> install the PWA on Android/iOS. Mani's Vault registers as a Share Target.</li>
            <li><strong>Share sheets:</strong> pick Mani's Vault in any app → the share sheet forwards <code>sharedUrl</code>, <code>sharedText</code>, and <code>sharedTitle</code> parameters to pre-fill the form instantly.</li>
            <li><strong>Clipboard watcher:</strong> copied content is detected whenever you return to the tab—no refresh required.</li>
            <li><strong>Images:</strong> upload files or paste image URLs; they appear in the dedicated Images tab.</li>
            <li><strong>Text:</strong> every snippet gets its own title so long transcripts stay organized.</li>
          </ul>
          <p class="text-xs text-slate-500">Tip: add the deployed URL as a shortcut on Android/iOS home screens for near-native capture speed.</p>
        </div>
      </div>
    </section>

    <section class="glass-panel rounded-3xl p-5" data-collapsible>
      <div class="section-header">
        <h2 class="text-xl font-semibold">Suggestions for the next upgrade</h2>
        <button type="button" class="section-toggle" data-toggle aria-label="Expand section">
          <span class="toggle-icon">+</span>
        </button>
      </div>
      <div class="collapsible-body text-sm text-slate-600 dark:text-slate-200">
        <ul class="list-disc list-inside space-y-1">
          <li>Hook up AI summaries to generate TL;DRs for long snippets.</li>
          <li>Add reminder dates so each bookmark can resurface via push notification.</li>
          <li>Enable multi-select actions (bulk delete, bulk export of specific folders).</li>
          <li>Tag collaborators and invite them through shared GitHub branches.</li>
          <li>Render timeline analytics (items saved per week/platform).</li>
          <li>Integrate RSS/Readwise-style auto-importers for saved sources.</li>
          <li>Provide Siri/Assistant shortcuts to save the current clipboard without opening the UI.</li>
          <li>Auto-tag entries using AI topic detection to keep folders tidy.</li>
          <li>Add spaced-repetition reminders for notes you want to revisit.</li>
        </ul>
      </div>
    </section>
  </div>

  <div id="clipboardModal" class="clipboard-modal hidden">
    <div class="clipboard-card space-y-4">
      <div>
        <h3 class="text-lg font-semibold">Clipboard content detected</h3>
        <p class="text-sm text-slate-500 dark:text-slate-300">Choose how you want to store it.</p>
      </div>
      <pre id="clipboardPreview" class="max-h-40 overflow-y-auto bg-slate-900/5 dark:bg-white/5 rounded-2xl p-3 text-xs whitespace-pre-wrap"></pre>
      <div class="grid gap-2 sm:grid-cols-3">
        <button type="button" data-clip-action="bookmark" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 text-sm font-medium">Save as Bookmark</button>
        <button type="button" data-clip-action="text" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 text-sm font-medium">Save as Text</button>
        <button type="button" data-clip-action="image" class="rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 text-sm font-medium">Save as Image</button>
      </div>
      <button type="button" data-clip-dismiss class="w-full rounded-2xl border border-slate-200 bg-white/60 px-4 py-2 text-sm">Dismiss</button>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    const STORAGE_KEY = 'universalBookmarkVault';
    const PLATFORM_PRESETS = ['All', 'YouTube', 'Article', 'Podcast', 'Tweet', 'Custom'];
    const THEME_SEQUENCE = ['sunrise', 'midnight', 'neon', 'glass'];
    const state = {
      theme: 'sunrise',
      bookmarks: [],
      filters: { folder: 'All', platform: 'All', search: '' },
      github: { owner: '', repo: '', path: 'data/bookmarks.json', token: '', sha: '' },
      activeLibraryTab: 'bookmarks',
      pagination: { page: 1, perPage: 30 },
      suggestionBank: []
    };
    let deferredPrompt = null;
    let collapsibleSections = [];
    let libraryTabButtons = [];
    let libraryPanels = [];
    let clipboardBuffer = '';
    let clipboardCooldown = false;
    let sharedImageAttachment = null;
    const clipboardState = { text: '' };

    const dom = {
      body: document.body,
      platformRail: document.getElementById('platformRail'),
      folderList: document.getElementById('folderList'),
      folderCount: document.getElementById('folderCount'),
      form: document.getElementById('bookmarkForm'),
      bookmarkGrid: document.getElementById('bookmarkGrid'),
      emptyState: document.getElementById('emptyState'),
      searchInput: document.getElementById('searchInput'),
      searchSuggestions: document.getElementById('searchSuggestions'),
      searchAutocomplete: document.getElementById('searchAutocomplete'),
      themeToggle: document.getElementById('themeToggle'),
      installBtn: document.getElementById('installPwaBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importInput: document.getElementById('importInput'),
      folderOptions: document.getElementById('folderOptions'),
      clearFilters: document.getElementById('clearFilters'),
      githubOwner: document.getElementById('githubOwner'),
      githubRepo: document.getElementById('githubRepo'),
      githubPath: document.getElementById('githubPath'),
      githubToken: document.getElementById('githubToken'),
      pullGithub: document.getElementById('pullGithub'),
      pushGithub: document.getElementById('pushGithub'),
      githubStatus: document.getElementById('githubStatus'),
      urlInput: document.getElementById('urlInput'),
      expandAll: document.getElementById('expandAll'),
      collapseAll: document.getElementById('collapseAll'),
      snippetList: document.getElementById('snippetList'),
      snippetEmpty: document.getElementById('snippetEmpty'),
      imageGrid: document.getElementById('imageGrid'),
      imageEmpty: document.getElementById('imageEmpty'),
      folderField: document.querySelector('input[name="folder"]'),
      clipboardModal: document.getElementById('clipboardModal'),
      clipboardPreview: document.getElementById('clipboardPreview'),
      saveEntryTop: document.getElementById('saveEntryTop'),
      clipboardCheck: document.getElementById('clipboardCheck'),
      bookmarkPagination: document.getElementById('bookmarkPagination'),
      paginationInfo: document.getElementById('paginationInfo'),
      prevPage: document.getElementById('prevPage'),
      nextPage: document.getElementById('nextPage'),
      toast: document.getElementById('toast')
    };

    document.addEventListener('DOMContentLoaded', init);

    function init() {
      loadState();
      hydrateLegacyBookmarks();
      hydrateGithubFields();
      renderAll();
      applyTheme();
      bindEvents();
      initCollapsibles();
      initLibraryTabs();
      setDefaultFolder();
      setupClipboardModal();
      prefillFromShareTarget();
      setupShareTargetListener();
      setupManifest();
      setupServiceWorker();
      setTimeout(() => promptClipboardCapture({ force: true }), 800);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        state.bookmarks = parsed.bookmarks || [];
        state.theme = parsed.theme || state.theme;
        state.github = { ...state.github, ...(parsed.github || {}) };
      } catch (err) {
        console.error('Failed to parse saved state', err);
      }
    }

    function hydrateLegacyBookmarks() {
      let mutated = false;
      state.bookmarks.forEach((bookmark) => {
        if (!bookmark.folder) {
          bookmark.folder = 'AI';
          mutated = true;
        }
        if (!bookmark.siteName) {
          bookmark.siteName = extractSiteName(bookmark.url);
          mutated = true;
        }
        if (!bookmark.thumbnail) {
          bookmark.thumbnail = getSitePreview(bookmark.url);
          mutated = true;
        }
        if (bookmark.textTitle === undefined) {
          bookmark.textTitle = '';
          mutated = true;
        }
        if (bookmark.imageTitle === undefined) {
          bookmark.imageTitle = '';
          mutated = true;
        }
        if (bookmark.imageUrl === undefined) {
          bookmark.imageUrl = '';
          mutated = true;
        }
      });
      if (mutated) {
        persistState();
      }
    }

    function persistState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        bookmarks: state.bookmarks,
        theme: state.theme,
        github: state.github
      }));
    }

    function hydrateGithubFields() {
      dom.githubOwner.value = state.github.owner;
      dom.githubRepo.value = state.github.repo;
      dom.githubPath.value = state.github.path;
      dom.githubToken.value = state.github.token;
    }

    function bindEvents() {
      dom.form.addEventListener('submit', handleAddBookmark);
      dom.searchInput.addEventListener('input', handleSearchInput);
      dom.searchInput.addEventListener('focus', handleSearchInput);
      document.addEventListener('click', (event) => {
        if (!dom.searchAutocomplete) return;
        if (event.target === dom.searchInput) return;
        if (dom.searchAutocomplete.contains(event.target)) return;
        hideAutocomplete();
      });
      dom.themeToggle.addEventListener('click', toggleTheme);
      dom.exportBtn.addEventListener('click', exportData);
      dom.importInput.addEventListener('change', importData);
      dom.clearFilters.addEventListener('click', () => {
        state.filters = { folder: 'All', platform: 'All', search: '' };
        dom.searchInput.value = '';
        hideAutocomplete();
        resetPagination();
        renderAll();
      });
      dom.githubOwner.addEventListener('input', (e) => updateGithubField('owner', e.target.value));
      dom.githubRepo.addEventListener('input', (e) => updateGithubField('repo', e.target.value));
      dom.githubPath.addEventListener('input', (e) => updateGithubField('path', e.target.value));
      dom.githubToken.addEventListener('input', (e) => updateGithubField('token', e.target.value));
      dom.pullGithub.addEventListener('click', pullFromGithub);
      dom.pushGithub.addEventListener('click', pushToGithub);
      dom.prevPage.addEventListener('click', () => changePage(-1));
      dom.nextPage.addEventListener('click', () => changePage(1));
      dom.clipboardCheck.addEventListener('click', () => promptClipboardCapture({ force: true, manual: true }));
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        dom.installBtn.disabled = false;
      });
      dom.installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) {
          alert('Use your browser menu to install this app.');
          return;
        }
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        dom.installBtn.disabled = true;
      });
      dom.saveEntryTop.addEventListener('click', (event) => {
        event.preventDefault();
        scrollToForm();
      });
      window.addEventListener('focus', () => setTimeout(() => promptClipboardCapture(), 300));
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          setTimeout(() => promptClipboardCapture(), 200);
        }
      });
      window.addEventListener('pageshow', () => setTimeout(() => promptClipboardCapture(), 300));
    }

    function handleSearchInput(e) {
      const value = e.target.value.toLowerCase();
      state.filters.search = value;
      resetPagination();
      renderBookmarkViews();
      renderAutocompleteSuggestions(value);
    }

    function initCollapsibles() {
      collapsibleSections = Array.from(document.querySelectorAll('[data-collapsible]'));
      collapsibleSections.forEach((section) => {
        const toggle = section.querySelector('[data-toggle]');
        const defaultOpen = section.hasAttribute('data-default-open');
        setSectionState(section, !defaultOpen);
        if (toggle) {
          toggle.addEventListener('click', () => toggleSection(section));
        }
      });
      dom.expandAll.addEventListener('click', () => setAllSections(false));
      dom.collapseAll.addEventListener('click', () => setAllSections(true));
    }

    function toggleSection(section) {
      const collapsed = section.dataset.collapsed === 'true';
      setSectionState(section, !collapsed);
    }

    function setSectionState(section, collapse) {
      const body = section.querySelector('.collapsible-body');
      const toggle = section.querySelector('[data-toggle]');
      if (!body || !toggle) return;
      if (collapse) {
        section.classList.add('is-collapsed');
        body.hidden = true;
      } else {
        section.classList.remove('is-collapsed');
        body.hidden = false;
      }
      toggle.innerHTML = collapse
        ? '<span class="toggle-icon">+</span>'
        : '<span class="toggle-icon">−</span>';
      toggle.setAttribute('aria-expanded', (!collapse).toString());
      toggle.setAttribute('aria-label', collapse ? 'Expand section' : 'Collapse section');
      section.dataset.collapsed = collapse ? 'true' : 'false';
    }

    function setAllSections(collapse) {
      collapsibleSections.forEach((section) => {
        setSectionState(section, collapse);
      });
    }

    function initLibraryTabs() {
      libraryTabButtons = Array.from(document.querySelectorAll('[data-library-tab]'));
      libraryPanels = Array.from(document.querySelectorAll('[data-tab-panel]'));
      libraryTabButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const tab = button.dataset.libraryTab;
          if (tab === state.activeLibraryTab) return;
          state.activeLibraryTab = tab;
          updateLibraryTabs();
        });
      });
      updateLibraryTabs();
    }

    function updateLibraryTabs() {
      libraryTabButtons.forEach((button) => {
        const active = button.dataset.libraryTab === state.activeLibraryTab;
        button.classList.toggle('active', active);
      });
      libraryPanels.forEach((panel) => {
        const active = panel.dataset.tabPanel === state.activeLibraryTab;
        panel.classList.toggle('hidden', !active);
      });
    }

    function setDefaultFolder() {
      if (dom.folderField && !dom.folderField.value) {
        dom.folderField.value = 'AI';
      }
    }

    async function handleAddBookmark(event) {
      event.preventDefault();
      const formData = new FormData(dom.form);
      const platform = formData.get('platform');
      const url = formData.get('url');
      const folder = (formData.get('folder') || 'AI').trim();
      const customTitle = formData.get('title');
      const tags = (formData.get('tags') || '').split(',').map((t) => t.trim()).filter(Boolean);
      const notes = formData.get('notes') || '';
      const textSnippet = formData.get('textSnippet') || '';
      const textTitle = (formData.get('textTitle') || '').trim();
      const imageTitle = (formData.get('imageTitle') || '').trim();
      const imageUrl = (formData.get('imageUrl') || '').trim();
      const imageFile = formData.get('image');

      if (!url && !textSnippet && (!imageFile || !imageFile.size) && !imageUrl && !sharedImageAttachment) {
        alert('Provide at least a URL, text snippet, or image.');
        return;
      }

      const bookmark = {
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36),
        url,
        platform,
        folder,
        tags,
        notes,
        textSnippet,
        textTitle,
        imageTitle,
        imageUrl,
        createdAt: new Date().toISOString(),
        title: customTitle,
        thumbnail: '',
        imageData: '',
        sourceType: detectSource(url),
        siteName: extractSiteName(url)
      };

      if (imageFile && imageFile.size) {
        bookmark.imageData = await fileToBase64(imageFile);
      } else if (sharedImageAttachment) {
        bookmark.imageData = sharedImageAttachment.data;
        bookmark.imageTitle = bookmark.imageTitle || sharedImageAttachment.name || 'Shared image';
        sharedImageAttachment = null;
      }

      if (url) {
        if (bookmark.sourceType === 'YouTube') {
          await populateYoutubeMeta(url, bookmark, customTitle);
        } else {
          bookmark.title = customTitle || bookmark.title || url;
        }
        if (!bookmark.thumbnail) {
          bookmark.thumbnail = getSitePreview(url);
        }
      } else {
        bookmark.title = customTitle || textTitle || imageTitle || 'Untitled entry';
      }

      state.bookmarks.unshift(bookmark);
      persistState();
      dom.form.reset();
      setDefaultFolder();
      resetPagination();
      renderAll();
      toast('Saved to Mani\'s vault');
    }

    function detectSource(url) {
      if (!url) return 'Custom';
      const u = url.toLowerCase();
      if (u.includes('youtube.com') || u.includes('youtu.be')) return 'YouTube';
      if (u.includes('twitter.com') || u.includes('x.com')) return 'Tweet';
      if (u.includes('spotify.com') || u.includes('apple.com/podcast')) return 'Podcast';
      if (u.includes('medium.com') || u.includes('dev.to') || u.includes('blog')) return 'Article';
      return 'Custom';
    }

    async function populateYoutubeMeta(url, bookmark, customTitle) {
      try {
        const response = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
        if (!response.ok) throw new Error('noembed failed');
        const data = await response.json();
        bookmark.title = customTitle || data.title || url;
        bookmark.thumbnail = data.thumbnail_url || '';
      } catch (err) {
        console.warn('Metadata fetch failed', err);
        bookmark.title = customTitle || url;
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function renderAll() {
      renderPlatformRail();
      renderFolders();
      hydrateFolderOptions();
      renderBookmarkViews();
      updateSearchSuggestions();
    }

    function renderBookmarkViews() {
      const filtered = getFilteredBookmarks();
      renderBookmarkGrid(filtered);
      renderSnippetList(filtered);
      renderImageGrid(filtered);
    }

    function getFilteredBookmarks() {
      return state.bookmarks.filter((bookmark) => {
        const folderMatch = state.filters.folder === 'All' || bookmark.folder === state.filters.folder;
        const platformMatch = state.filters.platform === 'All' || bookmark.platform === state.filters.platform || bookmark.sourceType === state.filters.platform;
        const haystack = [bookmark.title, bookmark.notes, bookmark.tags?.join(' '), bookmark.textSnippet, bookmark.folder, bookmark.siteName, bookmark.textTitle, bookmark.imageTitle]
          .join(' ')
          .toLowerCase();
        const searchMatch = !state.filters.search || haystack.includes(state.filters.search);
        return folderMatch && platformMatch && searchMatch;
      });
    }

    function renderPlatformRail() {
      const counts = PLATFORM_PRESETS.reduce((acc, key) => {
        acc[key] = key === 'All'
          ? state.bookmarks.length
          : state.bookmarks.filter((b) => (b.platform || b.sourceType) === key || b.sourceType === key).length;
        return acc;
      }, {});
      dom.platformRail.innerHTML = '';
      PLATFORM_PRESETS.forEach((platform) => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = `platform-chip border border-slate-200 ${state.filters.platform === platform ? 'active font-semibold' : ''}`;
        chip.innerHTML = `<div class="flex flex-col text-left"><span class="text-xs uppercase tracking-wide text-slate-500">${platform}</span><span class="text-lg font-semibold">${counts[platform] || 0}</span></div>`;
        chip.addEventListener('click', () => {
          state.filters.platform = platform;
          resetPagination();
          renderPlatformRail();
          renderBookmarkViews();
        });
        dom.platformRail.appendChild(chip);
      });
    }

    function renderFolders() {
      const folderSet = new Set(state.bookmarks.map((b) => b.folder || 'AI'));
      folderSet.add('AI');
      const folders = ['All', ...folderSet];
      dom.folderCount.textContent = `${folders.length - 1} folders`;
      dom.folderList.innerHTML = '';
      folders.forEach((folder) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `px-3 py-1.5 rounded-2xl border text-sm ${state.filters.folder === folder ? 'bg-slate-900 text-white' : 'bg-white/70 border-slate-200'}`;
        btn.textContent = folder;
        btn.addEventListener('click', () => {
          state.filters.folder = folder;
          resetPagination();
          renderFolders();
          renderBookmarkViews();
        });
        dom.folderList.appendChild(btn);
      });
    }

    function hydrateFolderOptions() {
      const existing = new Set();
      dom.folderOptions.innerHTML = '';
      ['AI', ...state.bookmarks.map((b) => b.folder)].forEach((folder) => {
        const value = folder || 'AI';
        if (existing.has(value)) return;
        existing.add(value);
        const option = document.createElement('option');
        option.value = value;
        dom.folderOptions.appendChild(option);
      });
    }

    function renderBookmarkGrid(bookmarks) {
      const total = bookmarks.length;
      const perPage = state.pagination.perPage;
      const totalPages = Math.max(1, Math.ceil(Math.max(total, 1) / perPage));
      if (state.pagination.page > totalPages) {
        state.pagination.page = totalPages;
      }
      const startIndex = (state.pagination.page - 1) * perPage;
      const paginated = bookmarks.slice(startIndex, startIndex + perPage);
      dom.bookmarkGrid.innerHTML = '';
      if (!paginated.length) {
        dom.emptyState.classList.remove('hidden');
        updatePaginationControls({ totalPages: 1, total: 0, showing: 0, startIndex: 0 });
        return;
      }
      dom.emptyState.classList.add('hidden');
      paginated.forEach((bookmark, index) => {
        const siteName = bookmark.siteName || extractSiteName(bookmark.url);
        const displayPlatform = siteName || bookmark.platform;
        const displayIndex = startIndex + index + 1;
        const card = document.createElement('article');
        card.className = 'bookmark-card';
        card.innerHTML = `
          <div class="bookmark-row">
            ${renderThumbnail(bookmark)}
            <div class="flex-1 space-y-2">
              <div class="bookmark-meta">
                <span class="bookmark-index">#${displayIndex.toString().padStart(2, '0')}</span>
                <span>${bookmark.folder}</span>
                <span>${displayPlatform || 'website'}</span>
              </div>
              <a href="${bookmark.url || '#'}" ${bookmark.url ? 'target="_blank" rel="noopener"' : ''} class="font-semibold leading-snug line-clamp-2">${bookmark.title || bookmark.url || bookmark.textTitle || 'Untitled entry'}</a>
              <p class="text-xs text-slate-500">${bookmark.url ? new Date(bookmark.createdAt).toLocaleString() : 'Saved locally'}</p>
            </div>
          </div>
          ${renderTags(bookmark.tags)}
          ${renderNotes(bookmark.notes)}
          <div class="flex gap-2">
            ${bookmark.url ? '<button class="flex-1 border border-slate-200 px-3 py-2 text-sm" data-action="copy">Copy link</button>' : ''}
            <button class="flex-1 border border-rose-200 text-rose-600 px-3 py-2 text-sm" data-action="delete">Delete</button>
          </div>
        `;
        if (bookmark.url) {
          card.querySelector('[data-action="copy"]').addEventListener('click', () => copyLink(bookmark.url));
        }
        card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteBookmark(bookmark.id));
        dom.bookmarkGrid.appendChild(card);
      });
      updatePaginationControls({ totalPages: Math.max(1, Math.ceil(total / perPage)), total, showing: paginated.length, startIndex });
    }

    function updatePaginationControls({ totalPages, total, showing, startIndex }) {
      if (!dom.bookmarkPagination) return;
      if (!total) {
        dom.bookmarkPagination.classList.add('hidden');
        return;
      }
      const endIndex = startIndex + showing;
      dom.bookmarkPagination.classList.remove('hidden');
      if (dom.paginationInfo) {
        dom.paginationInfo.textContent = `Page ${state.pagination.page} of ${totalPages} · Showing ${startIndex + 1}-${endIndex} of ${total}`;
      }
      dom.prevPage.disabled = state.pagination.page === 1;
      dom.nextPage.disabled = state.pagination.page === totalPages;
    }

    function changePage(delta) {
      const filtered = getFilteredBookmarks();
      const totalPages = Math.max(1, Math.ceil(Math.max(filtered.length, 1) / state.pagination.perPage));
      const target = Math.min(totalPages, Math.max(1, state.pagination.page + delta));
      if (target === state.pagination.page) return;
      state.pagination.page = target;
      renderBookmarkGrid(filtered);
    }

    function resetPagination() {
      state.pagination.page = 1;
    }

    function renderSnippetList(bookmarks) {
      if (!dom.snippetList) return;
      const snippets = bookmarks.filter((bookmark) => (bookmark.textSnippet || '').trim());
      dom.snippetList.innerHTML = '';
      if (!snippets.length) {
        dom.snippetEmpty.classList.remove('hidden');
        return;
      }
      dom.snippetEmpty.classList.add('hidden');
      snippets.forEach((bookmark, index) => {
        const card = document.createElement('article');
        card.className = 'snippet-card';
        card.innerHTML = `
          <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-500">
            <span>Snippet #${index + 1}</span>
            <span>${bookmark.folder}</span>
          </div>
          <h4 class="font-semibold">${bookmark.textTitle || bookmark.title || 'Untitled snippet'}</h4>
          <p class="text-sm text-slate-600 dark:text-slate-200 whitespace-pre-wrap">${bookmark.textSnippet}</p>
        `;
        dom.snippetList.appendChild(card);
      });
    }

    function renderImageGrid(bookmarks) {
      if (!dom.imageGrid) return;
      const images = bookmarks.filter((bookmark) => bookmark.imageData || bookmark.imageUrl);
      dom.imageGrid.innerHTML = '';
      if (!images.length) {
        dom.imageEmpty.classList.remove('hidden');
        return;
      }
      dom.imageEmpty.classList.add('hidden');
      images.forEach((bookmark, index) => {
        const card = document.createElement('article');
        card.className = 'image-card';
        const imgSrc = bookmark.imageData || bookmark.imageUrl;
        card.innerHTML = `
          <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-500">
            <span>Image #${index + 1}</span>
            <span>${bookmark.folder}</span>
          </div>
          <h4 class="font-semibold">${bookmark.imageTitle || bookmark.title || 'Reference image'}</h4>
          ${imgSrc ? `<img src="${imgSrc}" alt="${bookmark.imageTitle || 'Reference image'}">` : ''}
        `;
        dom.imageGrid.appendChild(card);
      });
    }

    function renderThumbnail(bookmark) {
      const previewSource = bookmark.imageData || bookmark.thumbnail || bookmark.imageUrl;
      if (!previewSource) {
        return '<div class="bookmark-thumb flex items-center justify-center text-xs text-slate-500">No preview</div>';
      }
      return `<img src="${previewSource}" alt="${bookmark.title || 'preview'}" class="bookmark-thumb">`;
    }

    function renderTags(tags = []) {
      if (!tags.length) return '';
      return `<div class="flex flex-wrap gap-2 text-xs">${tags.map((tag) => `<span class="px-2 py-1 rounded-full bg-slate-100 dark:bg-white/10">${tag}</span>`).join('')}</div>`;
    }

    function renderNotes(notes) {
      if (!notes) return '';
      return `<p class="text-sm text-slate-600 dark:text-slate-200">${notes}</p>`;
    }

    function copyLink(url) {
      if (!navigator.clipboard) {
        const textarea = document.createElement('textarea');
        textarea.value = url;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        textarea.remove();
        toast('Link copied');
        return;
      }
      navigator.clipboard.writeText(url).then(() => toast('Link copied')).catch(() => {
        alert('Unable to copy link');
      });
    }

    function deleteBookmark(id) {
      if (!confirm('Delete this entry?')) return;
      state.bookmarks = state.bookmarks.filter((bookmark) => bookmark.id !== id);
      persistState();
      renderAll();
      toast('Bookmark removed');
    }

    function updateSearchSuggestions() {
      if (!dom.searchSuggestions) return;
      const suggestions = new Set();
      state.bookmarks.forEach((bookmark) => {
        [bookmark.title, bookmark.siteName, bookmark.folder, bookmark.platform, ...(bookmark.tags || []), bookmark.textTitle, bookmark.imageTitle]
          .filter(Boolean)
          .forEach((value) => suggestions.add(value));
      });
      state.suggestionBank = Array.from(suggestions);
      dom.searchSuggestions.innerHTML = '';
      state.suggestionBank.slice(0, 20).forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        dom.searchSuggestions.appendChild(option);
      });
    }

    function renderAutocompleteSuggestions(query) {
      if (!dom.searchAutocomplete) return;
      if (!query) {
        hideAutocomplete();
        return;
      }
      const matches = state.suggestionBank
        .filter((value) => value && value.toLowerCase().includes(query))
        .slice(0, 6);
      if (!matches.length) {
        hideAutocomplete();
        return;
      }
      dom.searchAutocomplete.innerHTML = matches.map((match) => `<button type="button" class="autocomplete-item text-left w-full">${match}</button>`).join('');
      Array.from(dom.searchAutocomplete.children).forEach((btn) => {
        btn.addEventListener('click', () => {
          dom.searchInput.value = btn.textContent;
          state.filters.search = btn.textContent.toLowerCase();
          hideAutocomplete();
          resetPagination();
          renderBookmarkViews();
        });
      });
      dom.searchAutocomplete.classList.remove('hidden');
    }

    function hideAutocomplete() {
      if (!dom.searchAutocomplete) return;
      dom.searchAutocomplete.classList.add('hidden');
      dom.searchAutocomplete.innerHTML = '';
    }

    function promptClipboardCapture({ force = false, manual = false } = {}) {
      if (!navigator.clipboard?.readText) {
        if (manual) alert('Clipboard API unavailable in this browser.');
        return;
      }
      if (clipboardCooldown && !force) return;
      clipboardCooldown = true;
      setTimeout(() => { clipboardCooldown = false; }, 3500);
      navigator.clipboard.readText().then((text) => {
        if (!text) {
          if (manual) toast('Clipboard empty');
          return;
        }
        if (!force && text === clipboardBuffer) return;
        clipboardBuffer = text;
        clipboardState.text = text;
        showClipboardModal(text);
      }).catch((err) => {
        if (manual) alert('Clipboard permission denied.');
        console.warn('Clipboard read failed', err);
      });
    }

    function showClipboardModal(text) {
      if (!dom.clipboardModal) return;
      dom.clipboardPreview.textContent = text;
      dom.clipboardModal.classList.remove('hidden');
      dom.body.classList.add('modal-open');
    }

    function hideClipboardModal() {
      dom.clipboardModal.classList.add('hidden');
      dom.body.classList.remove('modal-open');
    }

    function setupClipboardModal() {
      if (!dom.clipboardModal) return;
      dom.clipboardModal.addEventListener('click', (event) => {
        if (event.target === dom.clipboardModal) {
          hideClipboardModal();
        }
      });
      dom.clipboardModal.querySelector('[data-clip-dismiss]').addEventListener('click', hideClipboardModal);
      dom.clipboardModal.querySelectorAll('[data-clip-action]').forEach((button) => {
        button.addEventListener('click', () => {
          handleClipboardAction(button.dataset.clipAction);
        });
      });
    }

    function handleClipboardAction(action) {
      const text = clipboardState.text;
      if (!text) {
        hideClipboardModal();
        return;
      }
      if (action === 'bookmark') {
        const url = extractFirstUrl(text);
        if (url) {
          dom.form.elements.url.value = url;
        }
        dom.form.elements.notes.value = text;
        toast('Clipboard dropped into bookmark form');
      } else if (action === 'text') {
        dom.form.elements.textSnippet.value = text;
        if (!dom.form.elements.textTitle.value) {
          dom.form.elements.textTitle.value = `Snippet ${new Date().toLocaleTimeString()}`;
        }
        toast('Clipboard saved as snippet');
      } else if (action === 'image') {
        const url = extractFirstUrl(text);
        if (url) {
          dom.form.elements.imageUrl.value = url;
          toast('Clipboard URL set as image reference');
        } else {
          toast('No image URL detected, pasted into notes instead');
          dom.form.elements.notes.value = text;
        }
      }
      hideClipboardModal();
      scrollToForm();
    }

    function extractFirstUrl(text) {
      if (!text) return '';
      const match = text.match(/https?:\/\/[^\s]+/i);
      return match ? match[0] : '';
    }

    function prefillFromShareTarget() {
      const params = new URLSearchParams(location.search);
      const payload = {
        url: params.get('sharedUrl') || params.get('url'),
        title: params.get('sharedTitle') || params.get('title'),
        text: params.get('sharedText') || params.get('text')
      };
      if (payload.url || payload.title || payload.text) {
        applySharePayload(payload);
        history.replaceState({}, document.title, location.pathname);
      }
    }

    function applySharePayload({ url, title, text }) {
      if (url) dom.form.elements.url.value = url;
      if (title) dom.form.elements.title.value = title;
      if (text) {
        dom.form.elements.notes.value = text;
        dom.form.elements.textSnippet.value = text;
        dom.form.elements.textTitle.value = dom.form.elements.textTitle.value || (title || 'Shared text');
      }
      if (url || text || title) {
        toast('Share data captured');
        scrollToForm();
      }
    }

    function setupShareTargetListener() {
      if (!('launchQueue' in window) || !window.launchQueue?.setConsumer) return;
      window.launchQueue.setConsumer(async (launchParams) => {
        if (!launchParams.files || !launchParams.files.length) return;
        for (const fileHandle of launchParams.files) {
          const file = await fileHandle.getFile();
          if (file.type.startsWith('text/')) {
            const text = await file.text();
            applySharePayload({ text, title: file.name });
          } else if (file.type.startsWith('image/')) {
            const data = await fileToBase64(file);
            sharedImageAttachment = { data, name: file.name };
            dom.form.elements.imageTitle.value = dom.form.elements.imageTitle.value || file.name;
            toast('Shared image ready to attach — just hit save');
            scrollToForm();
          }
        }
      });
    }

    function setupManifest() {
      const manifest = {
        name: "Mani's Bookmark Vault",
        short_name: 'Bookmark Vault',
        start_url: '.',
        display: 'standalone',
        theme_color: '#ffca3a',
        background_color: '#ffffff',
        icons: [],
        share_target: {
          action: '/',
          method: 'GET',
          params: {
            title: 'sharedTitle',
            text: 'sharedText',
            url: 'sharedUrl'
          }
        }
      };
      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(blob);
      let link = document.querySelector('link[rel="manifest"]');
      if (!link) {
        link = document.createElement('link');
        link.rel = 'manifest';
        document.head.appendChild(link);
      }
      link.href = manifestURL;
    }

    function setupServiceWorker() {
      if (!('serviceWorker' in navigator)) return;
      const swCode = `self.addEventListener('install', (event) => {self.skipWaiting();});self.addEventListener('activate', (event) => {event.waitUntil(self.clients.claim());});self.addEventListener('fetch', () => {});`;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).catch((err) => console.warn('SW registration failed', err));
    }

    function handleGithubStatus(message) {
      dom.githubStatus.textContent = `Status: ${message}`;
    }

    function updateGithubField(field, value) {
      state.github[field] = value;
      persistState();
    }

    async function pullFromGithub() {
      const { owner, repo, path, token } = state.github;
      if (!owner || !repo || !path) {
        alert('Fill owner, repo, and path first.');
        return;
      }
      handleGithubStatus('Pulling...');
      const headers = token ? { Authorization: `Bearer ${token}` } : {};
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { headers });
        if (!res.ok) throw new Error('GitHub pull failed');
        const data = await res.json();
        const decoded = atob((data.content || '').replace(/\n/g, ''));
        const parsed = JSON.parse(decoded);
        state.bookmarks = parsed.bookmarks || parsed;
        state.github.sha = data.sha;
        persistState();
        renderAll();
        handleGithubStatus('Pulled successfully');
        toast('Pulled from GitHub');
      } catch (err) {
        console.error(err);
        handleGithubStatus('Pull failed');
        alert('Unable to pull from GitHub.');
      }
    }

    async function pushToGithub() {
      const { owner, repo, path, token, sha } = state.github;
      if (!owner || !repo || !path || !token) {
        alert('Fill owner, repo, path, and token to push.');
        return;
      }
      handleGithubStatus('Pushing...');
      const payload = {
        message: 'Update bookmark vault',
        content: btoa(unescape(encodeURIComponent(JSON.stringify({ bookmarks: state.bookmarks, updatedAt: new Date().toISOString() }, null, 2)))),
        sha: sha || undefined
      };
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('GitHub push failed');
        const data = await res.json();
        state.github.sha = data.content?.sha || state.github.sha;
        persistState();
        handleGithubStatus('Pushed successfully');
        toast('Pushed to GitHub');
      } catch (err) {
        console.error(err);
        handleGithubStatus('Push failed');
        alert('Unable to push to GitHub.');
      }
    }

    function exportData() {
      const blob = new Blob([JSON.stringify({ bookmarks: state.bookmarks, exportedAt: new Date().toISOString() }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bookmark-vault.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast('Exported JSON');
    }

    function importData(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      file.text().then((text) => {
        try {
          const parsed = JSON.parse(text);
          state.bookmarks = parsed.bookmarks || parsed;
          persistState();
          renderAll();
          toast('Import complete');
        } catch (err) {
          alert('Invalid JSON file.');
        }
      }).finally(() => {
        dom.importInput.value = '';
      });
    }

    function scrollToForm() {
      dom.form?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function applyTheme() {
      dom.body.setAttribute('data-theme', state.theme);
      const label = state.theme.charAt(0).toUpperCase() + state.theme.slice(1);
      dom.themeToggle.textContent = `Theme: ${label}`;
    }

    function toggleTheme() {
      const currentIndex = THEME_SEQUENCE.indexOf(state.theme);
      const nextIndex = (currentIndex + 1) % THEME_SEQUENCE.length;
      state.theme = THEME_SEQUENCE[nextIndex];
      persistState();
      applyTheme();
    }

    function getSitePreview(url) {
      if (!url) return '';
      try {
        const { hostname } = new URL(url);
        return `https://www.google.com/s2/favicons?sz=64&domain=${hostname}`;
      } catch (err) {
        return '';
      }
    }

    function extractSiteName(url) {
      if (!url) return '';
      try {
        const { hostname } = new URL(url);
        return hostname.replace('www.', '');
      } catch (err) {
        return '';
      }
    }

    function toast(message) {
      if (!dom.toast) return;
      dom.toast.textContent = message;
      dom.toast.classList.add('visible');
      clearTimeout(dom.toast._timeout);
      dom.toast._timeout = setTimeout(() => dom.toast.classList.remove('visible'), 2200);
    }
  </script>
</body>
</html>
