<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f59e0b" id="themeColorMeta" />
  <title>Mani's Bookmark Vault</title>
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --amber: #f59e0b;
      --slate: #1e293b;
      --bg-light-start: #fffbeb;
      --bg-light-mid: #fef3c7;
      --bg-light-end: #dbeafe;
      --bg-dark-start: #0f172a;
      --bg-dark-mid: #1e293b;
      --card-light: rgba(255, 255, 255, 0.92);
      --card-dark: rgba(30, 41, 59, 0.95);
      --text-light: #1e293b;
      --text-dark: #f1f5f9;
      --muted: #94a3b8;
      --danger: #ef4444;
      --success: #22c55e;
      --border-light: rgba(0, 0, 0, 0.08);
      --border-dark: rgba(255, 255, 255, 0.08);
      color: var(--text-light);
      background: linear-gradient(135deg, var(--bg-light-start), var(--bg-light-mid), var(--bg-light-end));
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg-light-start), var(--bg-light-mid), var(--bg-light-end));
      color: var(--text-light);
      -webkit-font-smoothing: antialiased;
      padding-bottom: calc(80px + env(safe-area-inset-bottom));
      padding-top: env(safe-area-inset-top);
      transition: background 0.4s ease, color 0.4s ease;
      touch-action: manipulation;
    }
    body.dark {
      background: linear-gradient(135deg, var(--bg-dark-start), var(--bg-dark-mid), var(--bg-dark-end));
      color: var(--text-dark);
    }
    *, *::before, *::after { box-sizing: border-box; }
    button {
      border: none;
      background: none;
      font: inherit;
      padding: 0;
      cursor: pointer;
      color: inherit;
      min-height: 44px;
      min-width: 44px;
    }
    .app-container {
      width: min(960px, 100%);
      margin: 0 auto;
      padding: 16px;
      padding-bottom: calc(120px + env(safe-area-inset-bottom));
    }
    .card {
      background: var(--card-light);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border-light);
    }
    body.dark .card {
      background: var(--card-dark);
      border: 1px solid var(--border-dark);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .title-block h1 {
      font-size: 28px;
      margin: 0;
      font-weight: 700;
    }
    .title-block p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 14px;
    }
    .settings-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(245, 158, 11, 0.15);
      color: var(--amber);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .search-box {
      position: relative;
      margin-bottom: 16px;
    }
    .search-box input {
      width: 100%;
      padding: 12px 44px;
      border-radius: 16px;
      border: 1px solid var(--border-light);
      font-size: 16px;
      background: #fff;
      color: inherit;
    }
    body.dark .search-box input {
      background: rgba(30,41,59,0.95);
      border: 1px solid var(--border-dark);
    }
    .search-box svg {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }
    .search-icon { left: 16px; }
    .clear-btn { right: 16px; display: none; }
    .clear-btn.show { display: block; }
    .horizontal-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 16px;
      scrollbar-width: none;
    }
    .horizontal-scroll::-webkit-scrollbar { display: none; }
    .stat-card {
      min-width: 120px;
      padding: 16px;
      border-radius: 16px;
      background: rgba(255,255,255,0.85);
      border: 1px solid var(--border-light);
    }
    body.dark .stat-card {
      background: rgba(30,41,59,0.95);
      border: 1px solid var(--border-dark);
    }
    .stat-value { font-size: 24px; font-weight: 700; }
    .pill {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: rgba(255,255,255,0.9);
      font-size: 14px;
      white-space: nowrap;
    }
    body.dark .pill {
      border: 1px solid var(--border-dark);
      background: rgba(30,41,59,0.9);
    }
    .pill.active {
      background: var(--slate);
      color: #fff;
      border-color: var(--slate);
    }
    body.dark .pill.active {
      background: #fff;
      color: var(--slate);
    }
    .tabs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .tab-btn {
      border-radius: 16px;
      background: rgba(255,255,255,0.6);
      padding: 12px;
      font-weight: 600;
    }
    .tab-btn.active {
      background: #fff;
      box-shadow: 0 12px 24px rgba(15,23,42,0.12);
    }
    body.dark .tab-btn { background: rgba(30,41,59,0.7); }
    body.dark .tab-btn.active { background: rgba(15,23,42,0.9); }
    .bookmark-card {
      display: grid;
      grid-template-columns: minmax(140px, 200px) 1fr;
      gap: 16px;
      align-items: flex-start;
    }
    .bookmark-media {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      max-width: 200px;
      flex-wrap: wrap;
    }
    .bookmark-thumb {
      width: 96px;
      height: 96px;
      border-radius: 16px;
      object-fit: cover;
      background: #e2e8f0;
      flex-shrink: 0;
    }
    .thumb-caption {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-light);
      line-height: 1.3;
      flex: 1;
      min-width: 140px;
    }
    .thumb-caption a {
      color: inherit;
      text-decoration: none;
    }
    body.dark .bookmark-thumb { background: #0f172a; }
    body.dark .thumb-caption { color: var(--text-dark); }
    .bookmark-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(245,158,11,0.12);
      color: var(--amber);
      font-size: 12px;
      font-weight: 600;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
    }
    .tag {
      padding: 6px 12px;
      border-radius: 12px;
      background: rgba(99,102,241,0.1);
      font-size: 12px;
    }
    body.dark .tag { background: rgba(99,102,241,0.2); }
    .card-actions {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .card-actions button {
      flex: 1;
      border-radius: 12px;
      padding: 12px;
      background: rgba(15,23,42,0.05);
    }
    body.dark .card-actions button { background: rgba(255,255,255,0.08); }
    .snippet-card pre {
      white-space: pre-wrap;
      font-family: inherit;
      margin: 0;
    }
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }
    .image-card img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 16px;
    }
    .load-more {
      width: 100%;
      border-radius: 16px;
      background: var(--slate);
      color: #fff;
      margin: 16px 0 32px;
    }
    .fab {
      position: fixed;
      right: 20px;
      bottom: calc(90px + env(safe-area-inset-bottom));
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle at top, #fcd34d, #f59e0b);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 20px 35px rgba(245,158,11,0.5);
      z-index: 30;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(15,23,42,0.8);
      color: #cbd5f5;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      z-index: 20;
      backdrop-filter: blur(20px);
    }
    .bottom-nav button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #94a3b8;
    }
    .bottom-nav button.active { color: var(--amber); }
    .modal, .sheet {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: none;
      z-index: 100;
    }
    .modal.open, .sheet.open { display: block; }
    .modal-backdrop, .sheet-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.45);
    }
    .modal-content, .sheet-content {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      max-height: 90vh;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      background: #fff;
      padding: 16px;
      overflow-y: auto;
    }
    body.dark .modal-content, body.dark .sheet-content { background: #1e293b; }
    body.locked { overflow: hidden; }
    .modal-header, .sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .drag-handle {
      width: 60px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148,163,184,0.5);
      margin: 0 auto 12px;
    }
    form label {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      gap: 6px;
      margin-bottom: 12px;
    }
    form input, form textarea, form select {
      border-radius: 12px;
      border: 1px solid var(--border-light);
      padding: 12px;
      font-size: 16px;
      background: rgba(255,255,255,0.9);
    }
    body.dark form input, body.dark form textarea, body.dark form select {
      background: rgba(15,23,42,0.6);
      border: 1px solid var(--border-dark);
      color: #fff;
    }
    textarea { min-height: 100px; resize: vertical; }
    .sheet-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .sheet-actions button {
      flex: 1 1 calc(50% - 12px);
      border-radius: 16px;
      background: rgba(15,23,42,0.05);
      padding: 12px;
    }
    body.dark .sheet-actions button {
      background: rgba(255,255,255,0.08);
    }
    .toast {
      position: fixed;
      bottom: calc(120px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(15,23,42,0.9);
      color: #fff;
      padding: 12px 24px;
      border-radius: 999px;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 200;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .hidden { display: none !important; }
    .settings-view { display: none; }
    .settings-view.active { display: block; }
    .home-view.hidden { display: none; }
    @media (min-width: 768px) {
      .bottom-nav { position: sticky; bottom: 0; }
      body { padding-bottom: 40px; }
      .fab { bottom: 40px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body>
  <div class="app-container">
    <section id="homeView" class="home-view">
      <div class="header">
        <div class="title-block">
          <h1>Bookmarks</h1>
          <p id="itemCount">0 items</p>
        </div>
        <button class="settings-btn" id="openSettings" aria-label="Open settings">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.4 1.31 1.03 1.58.63.27 1.31.04 1.77-.42l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V15z"></path>
          </svg>
        </button>
      </div>
      <div class="search-box">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="search" id="searchInput" placeholder="Search..." autocomplete="off" autocorrect="off" spellcheck="false" list="searchSuggestions" />
        <datalist id="searchSuggestions"></datalist>
        <button class="clear-btn" id="clearSearch" aria-label="Clear search">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="horizontal-scroll" id="statsRow">
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statToday">0</div>
          <div class="stat-label">Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statWeek">0</div>
          <div class="stat-label">Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statFolders">0</div>
          <div class="stat-label">Folders</div>
        </div>
      </div>
      <div class="horizontal-scroll" id="platformRow"></div>
      <div class="horizontal-scroll" id="folderRow"></div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="bookmarks">Bookmarks</button>
        <button class="tab-btn" data-tab="snippets">Snippets</button>
        <button class="tab-btn" data-tab="images">Images</button>
      </div>
      <div id="contentArea">
        <div id="bookmarksPanel"></div>
        <div id="snippetsPanel" class="hidden"></div>
        <div id="imagesPanel" class="hidden"></div>
      </div>
      <button class="load-more hidden" id="loadMore" aria-label="Load more">Load More</button>
    </section>
    <section id="settingsView" class="settings-view">
      <div class="header">
        <button id="backHome" aria-label="Back to home">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <h2>Settings</h2>
        <span style="width:44px;"></span>
      </div>
      <div class="card">
        <h3>Appearance</h3>
        <button id="openThemeSheet" style="width:100%; text-align:left; display:flex; justify-content:space-between; align-items:center;">
          Theme <span id="themeLabel">Light</span>
        </button>
      </div>
      <div class="card" id="guidesCard">
        <h3>Guides</h3>
        <div style="display:flex; flex-direction:column; gap:12px; font-size:14px; color:var(--muted);">
          <details>
            <summary style="cursor:pointer; font-weight:600; color:inherit;">Publish to GitHub Pages</summary>
            <ol style="margin:8px 0 0 18px;">
              <li>Create a new repo like <strong>bookmark-vault</strong>.</li>
              <li>Upload this <em>index.html</em> file to the repo root.</li>
              <li>In repo settings → Pages, choose <strong>deploy from branch</strong> and select <strong>main / root</strong>.</li>
              <li>Wait for the green check, then visit <code>https://USERNAME.github.io/REPO</code>.</li>
            </ol>
          </details>
          <details>
            <summary style="cursor:pointer; font-weight:600; color:inherit;">GitHub Sync Tips</summary>
            <ul style="margin:8px 0 0 18px;">
              <li>Owner = username/org, Repo = repo name, Path = e.g. <code>data/bookmarks.json</code>.</li>
              <li>Token needs <code>repo</code> scope (classic) or <code>contents:write</code> (fine-grained).</li>
              <li>Tap <strong>Pull</strong> to overwrite local data with the repo file.</li>
              <li>Tap <strong>Push</strong> to upload current data (stores SHA for next push).</li>
            </ul>
          </details>
          <details>
            <summary style="cursor:pointer; font-weight:600; color:inherit;">Share From Other Apps</summary>
            <ul style="margin:8px 0 0 18px;">
              <li>Install the PWA first so it appears in the native share sheet.</li>
              <li>Share any link/text to “Bookmarks” and the add modal opens pre-filled.</li>
              <li>The app reads <em>title</em>, <em>text</em>, and <em>url</em> query params automatically.</li>
            </ul>
          </details>
        </div>
      </div>
      <div class="card">
        <h3>Data</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button id="exportBtn" style="flex:1; border-radius:12px; background:rgba(15,23,42,0.05);">Export JSON</button>
          <button id="importBtn" style="flex:1; border-radius:12px; background:rgba(15,23,42,0.05);">Import JSON</button>
          <input type="file" id="importInput" accept="application/json" class="hidden" />
        </div>
        <button id="clearData" style="width:100%; margin-top:12px; color:var(--danger);">Clear All Data</button>
      </div>
      <div class="card">
        <h3>GitHub Sync</h3>
        <label>Owner<input type="text" id="ghOwner"></label>
        <label>Repo<input type="text" id="ghRepo"></label>
        <label>Path<input type="text" id="ghPath"></label>
        <label>Token<input type="password" id="ghToken"></label>
        <div style="display:flex; gap:12px;">
          <button id="pullBtn" style="flex:1; border-radius:12px; background:rgba(15,23,42,0.05);">Pull</button>
          <button id="pushBtn" style="flex:1; border-radius:12px; background:rgba(15,23,42,0.05);">Push</button>
        </div>
        <p id="githubStatus" style="font-size:13px; color:var(--muted); margin-top:8px;">Disconnected</p>
      </div>
      <div class="card">
        <h3>About</h3>
        <p>Mani's Bookmark Vault v2.1</p>
        <button id="installBtn" disabled style="width:100%; border-radius:12px; background:var(--slate); color:#fff;">Install App</button>
      </div>
    </section>
  </div>

  <button class="fab" id="fabAdd" aria-label="Add bookmark">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </button>

  <nav class="bottom-nav" id="bottomNav">
    <button data-nav="home" class="active" aria-label="Home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7"></path><path d="M9 22V12h6v10"></path></svg>
      <span>Home</span>
    </button>
    <button data-nav="search" aria-label="Search">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <span>Search</span>
    </button>
    <button data-nav="clip" aria-label="Clipboard">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
      <span>Clip</span>
    </button>
    <button data-nav="folders" aria-label="Folders">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h5l2 3h11v9H3z"></path></svg>
      <span>Folders</span>
    </button>
  </nav>

  <div class="modal" id="addModal" aria-hidden="true">
    <div class="modal-backdrop" data-close="modal"></div>
    <div class="modal-content">
      <div class="drag-handle"></div>
      <div class="modal-header">
        <button id="cancelModal">Cancel</button>
        <h3 id="modalTitle">Add Bookmark</h3>
        <button id="saveBookmarkBtn" style="color:var(--amber); font-weight:600;">Save</button>
      </div>
      <form id="bookmarkForm">
        <section>
          <h4>Basic Information</h4>
          <label>URL
            <input type="url" id="urlInput" placeholder="https://" inputmode="url" />
          </label>
          <label>Title
            <input type="text" id="titleInput" placeholder="Title" />
          </label>
          <div style="display:flex; gap:12px;">
            <label style="flex:1;">Platform
              <select id="platformSelect">
                <option>YouTube</option>
                <option>Article</option>
                <option>Podcast</option>
                <option>Tweet</option>
                <option>Custom</option>
              </select>
            </label>
            <label style="flex:1;">Folder
              <input type="text" id="folderInput" list="folderList" placeholder="General" />
              <datalist id="folderList"></datalist>
            </label>
          </div>
          <label>Tags (comma separated)
            <input type="text" id="tagsInput" placeholder="design, ai" />
          </label>
          <label>Notes
            <textarea id="notesInput" placeholder="Notes"></textarea>
          </label>
        </section>
        <hr />
        <section>
          <h4>Text Snippet</h4>
          <label>Snippet Title
            <input type="text" id="snippetTitleInput" />
          </label>
          <label>Snippet Content
            <textarea id="snippetContentInput"></textarea>
          </label>
        </section>
        <hr />
        <section>
          <h4>Image</h4>
          <label>Image Title
            <input type="text" id="imageTitleInput" />
          </label>
          <label>Image URL
            <input type="url" id="imageUrlInput" placeholder="https://" />
          </label>
          <label>Upload Image
            <input type="file" id="imageUploadInput" accept="image/*" />
          </label>
          <div id="imagePreview" class="hidden">
            <img src="" alt="Preview" style="width:100%; border-radius:16px; margin-top:8px;" />
            <button type="button" id="removeImage" style="width:100%; margin-top:8px;">Remove Image</button>
          </div>
        </section>
      </form>
    </div>
  </div>

  <div class="sheet" id="clipboardSheet" aria-hidden="true">
    <div class="sheet-backdrop" data-close="sheet"></div>
    <div class="sheet-content">
      <div class="drag-handle"></div>
      <div class="sheet-header">
        <h3>Clipboard Content</h3>
        <button data-close="sheet" aria-label="Close clipboard">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div id="clipboardPreview" style="padding:12px; background:rgba(15,23,42,0.05); border-radius:16px; min-height:80px;"></div>
      <div class="sheet-actions" style="margin-top:16px;">
        <button data-clip="bookmark">Save as Bookmark</button>
        <button data-clip="snippet">Save as Text Snippet</button>
        <button data-clip="image">Save as Image URL</button>
        <button data-close="sheet">Dismiss</button>
      </div>
    </div>
  </div>

  <div class="sheet" id="themeSheet" aria-hidden="true">
    <div class="sheet-backdrop" data-close="sheet"></div>
    <div class="sheet-content">
      <div class="drag-handle"></div>
      <h3>Choose Theme</h3>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <button class="pill" data-theme="light" style="flex:1;">Light</button>
        <button class="pill" data-theme="dark" style="flex:1;">Dark</button>
      </div>
    </div>
  </div>

  <div class="sheet" id="folderSheet" aria-hidden="true">
    <div class="sheet-backdrop" data-close="sheet"></div>
    <div class="sheet-content">
      <div class="drag-handle"></div>
      <h3>Select Folder</h3>
      <div id="folderListSheet" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;"></div>
    </div>
  </div>

  <div class="sheet" id="actionSheet" aria-hidden="true">
    <div class="sheet-backdrop" data-close="sheet"></div>
    <div class="sheet-content">
      <div class="drag-handle"></div>
      <h3 id="actionSheetTitle">Bookmark</h3>
      <div style="display:flex; flex-direction:column; gap:12px; margin-top:12px;">
        <button data-action="edit">Edit</button>
        <button data-action="copy">Copy Link</button>
        <button data-action="share">Share</button>
        <button data-action="delete" style="color:var(--danger);">Delete</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = {
      bookmarks: [],
      theme: 'light',
      filter: { platform: 'All', folder: 'All', search: '' },
      tab: 'bookmarks',
      page: 1,
      suggestions: [],
      editId: null,
      selectedId: null,
      clipboardContent: '',
      imageData: '',
      github: { owner: '', repo: '', path: '', token: '', sha: '' },
      deferredPrompt: null
    };

    document.addEventListener('DOMContentLoaded', init);

    function init() {
      loadData();
      applyTheme();
      setupEvents();
      render();
      setupPWA();
      checkShareTarget();
    }

    function loadData() {
      try {
        const saved = localStorage.getItem('bookmarkVault');
        if (saved) {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed.bookmarks)) state.bookmarks = parsed.bookmarks;
          if (parsed.theme) state.theme = parsed.theme;
          if (parsed.github) state.github = { ...state.github, ...parsed.github };
        }
      } catch (err) {
        console.error('loadData', err);
        toast('Failed to load data');
      }
      $('ghOwner').value = state.github.owner || '';
      $('ghRepo').value = state.github.repo || '';
      $('ghPath').value = state.github.path || '';
      $('ghToken').value = state.github.token || '';
    }

    function saveData() {
      try {
        localStorage.setItem('bookmarkVault', JSON.stringify({
          bookmarks: state.bookmarks,
          theme: state.theme,
          github: state.github
        }));
      } catch (err) {
        console.error('saveData', err);
        toast('Storage error');
      }
    }

    function setupEvents() {
      document.querySelectorAll('.bottom-nav button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          handleNav(btn.dataset.nav);
        });
      });
      $('fabAdd').addEventListener('click', (e) => { e.preventDefault(); openAddModal(); });
      $('openSettings').addEventListener('click', () => showView('settings'));
      $('backHome').addEventListener('click', () => showView('home'));
      $('searchInput').addEventListener('input', (e) => {
        state.filter.search = e.target.value.trim();
        $('clearSearch').classList.toggle('show', state.filter.search.length > 0);
        state.page = 1;
        renderContent();
      });
      $('clearSearch').addEventListener('click', () => {
        state.filter.search = '';
        $('searchInput').value = '';
        $('clearSearch').classList.remove('show');
        renderContent();
      });
      document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
      $('cancelModal').addEventListener('click', closeAddModal);
      $('saveBookmarkBtn').addEventListener('click', saveBookmark);
      $('urlInput').addEventListener('blur', fetchMetadata);
      $('imageUploadInput').addEventListener('change', handleImageUpload);
      $('removeImage').addEventListener('click', () => {
        state.imageData = '';
        $('imagePreview').classList.add('hidden');
      });
      $('openThemeSheet').addEventListener('click', () => openSheet('themeSheet'));
      document.querySelectorAll('#themeSheet [data-theme]').forEach(btn => btn.addEventListener('click', () => setTheme(btn.dataset.theme)));
      $('exportBtn').addEventListener('click', exportData);
      $('importBtn').addEventListener('click', () => $('importInput').click());
      $('importInput').addEventListener('change', importData);
      $('clearData').addEventListener('click', clearAllData);
      $('pullBtn').addEventListener('click', pullGitHub);
      $('pushBtn').addEventListener('click', pushGitHub);
      $('installBtn').addEventListener('click', installPWA);
      $('githubStatus').textContent = 'Disconnected';
      ['ghOwner','ghRepo','ghPath','ghToken'].forEach(id => {
        $(id).addEventListener('input', () => {
          state.github = {
            ...state.github,
            owner: $('ghOwner').value.trim(),
            repo: $('ghRepo').value.trim(),
            path: $('ghPath').value.trim(),
            token: $('ghToken').value.trim()
          };
          saveData();
        });
      });
      document.querySelectorAll('[data-close="sheet"]').forEach(btn => btn.addEventListener('click', closeAllSheets));
      document.querySelectorAll('[data-close="modal"]').forEach(btn => btn.addEventListener('click', closeAddModal));
      document.querySelectorAll('#clipboardSheet [data-clip]').forEach(btn => btn.addEventListener('click', () => handleClipAction(btn.dataset.clip)));
      $('loadMore').addEventListener('click', () => {
        state.page += 1;
        renderBookmarks();
      });
      $('bookmarkForm').addEventListener('submit', (e) => { e.preventDefault(); });
      document.querySelector('[data-nav="clip"]').addEventListener('click', readClipboard);
      document.querySelector('[data-nav="folders"]').addEventListener('click', showFolderSheet);
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        state.deferredPrompt = e;
        $('installBtn').disabled = false;
      });
    }

    function handleNav(type) {
      document.querySelectorAll('.bottom-nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.nav === type || (type === 'home' && btn.dataset.nav === 'home')));
      if (type === 'home') {
        showView('home');
      } else if (type === 'search') {
        showView('home');
        $('searchInput').focus();
      } else if (type === 'clip') {
        readClipboard();
      } else if (type === 'folders') {
        showFolderSheet();
      }
    }

    function showView(view) {
      if (view === 'settings') {
        $('homeView').classList.add('hidden');
        $('settingsView').classList.add('active');
      } else {
        $('homeView').classList.remove('hidden');
        $('settingsView').classList.remove('active');
      }
    }

    function switchTab(tab) {
      state.tab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
      $('bookmarksPanel').classList.toggle('hidden', tab !== 'bookmarks');
      $('snippetsPanel').classList.toggle('hidden', tab !== 'snippets');
      $('imagesPanel').classList.toggle('hidden', tab !== 'images');
      renderContent();
    }

    function resetFilters() {
      state.filter = { platform: 'All', folder: 'All', search: '' };
      state.page = 1;
      $('searchInput').value = '';
      $('clearSearch').classList.remove('show');
      render();
    }

    function render() {
      renderStats();
      renderPlatforms();
      renderFolders();
      renderContent();
      updateFolderDatalist();
    }

    function renderStats() {
      const total = state.bookmarks.length;
      const today = state.bookmarks.filter(b => sameDay(new Date(b.createdAt), new Date())).length;
      const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
      const week = state.bookmarks.filter(b => new Date(b.createdAt).getTime() >= weekAgo).length;
      const folders = new Set(state.bookmarks.map(b => b.folder || 'General')).size;
      $('statTotal').textContent = total;
      $('statToday').textContent = today;
      $('statWeek').textContent = week;
      $('statFolders').textContent = folders;
      $('itemCount').textContent = `${total} items`;
    }

    function sameDay(a, b) {
      return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
    }

    function renderPlatforms() {
      const platforms = ['All','YouTube','Article','Podcast','Tweet','Custom'];
      const row = $('platformRow');
      row.innerHTML = '';
      platforms.forEach(p => {
        const count = p === 'All' ? state.bookmarks.length : state.bookmarks.filter(b => (b.platform || 'Article') === p).length;
        const btn = document.createElement('button');
        btn.className = 'pill' + (state.filter.platform === p ? ' active' : '');
        btn.textContent = `${p} (${count})`;
        btn.addEventListener('click', () => {
          state.filter.platform = p;
          state.page = 1;
          renderContent();
          renderPlatforms();
        });
        row.appendChild(btn);
      });
    }

    function renderFolders() {
      const row = $('folderRow');
      row.innerHTML = '';
      const folders = ['All', ...Array.from(new Set(state.bookmarks.map(b => b.folder || 'General'))).sort()];
      folders.forEach(f => {
        const count = f === 'All' ? state.bookmarks.length : state.bookmarks.filter(b => (b.folder || 'General') === f).length;
        const btn = document.createElement('button');
        btn.className = 'pill' + (state.filter.folder === f ? ' active' : '');
        btn.textContent = `${f} (${count})`;
        btn.addEventListener('click', () => {
          state.filter.folder = f;
          state.page = 1;
          renderContent();
          renderFolders();
        });
        row.appendChild(btn);
      });
    }

    function renderContent() {
      if (state.tab === 'bookmarks') renderBookmarks();
      else if (state.tab === 'snippets') renderSnippets();
      else renderImages();
      updateSearchSuggestions();
    }

    function getFiltered() {
      const search = state.filter.search.toLowerCase();
      return state.bookmarks.filter(b => {
        const platformMatch = state.filter.platform === 'All' || (b.platform || 'Article') === state.filter.platform;
        const folderMatch = state.filter.folder === 'All' || (b.folder || 'General') === state.filter.folder;
        const searchTarget = [b.title, b.url, b.notes, (b.tags || []).join(','), b.snippetTitle, b.snippetContent, b.imageTitle].join(' ').toLowerCase();
        const searchMatch = !search || searchTarget.includes(search);
        return platformMatch && folderMatch && searchMatch;
      });
    }

    function renderBookmarks() {
      const panel = $('bookmarksPanel');
      const filtered = getFiltered();
      const perPage = 20;
      const end = state.page * perPage;
      const list = filtered.slice(0, end);
      panel.innerHTML = '';
      if (!list.length) {
        panel.innerHTML = '<p style="text-align:center; color:var(--muted);">No bookmarks yet.</p>';
      }
      list.forEach((b, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="bookmark-card">
            <div class="bookmark-media">
              <img class="bookmark-thumb" loading="lazy" src="${b.thumbnail || b.imageData || b.imageUrl || getFavicon(b.url || '')}" alt="Thumbnail" />
              ${b.platform === 'YouTube' && b.title ? `<div class="thumb-caption">${b.url ? `<a href="${b.url}" target="_blank" rel="noopener">${esc(b.title)}</a>` : esc(b.title)}</div>` : ''}
            </div>
            <div>
              <div class="bookmark-meta">
                <span class="badge">#${idx + 1}</span>
                <span>${b.platform || 'Article'}</span>
                <span>${b.folder || 'General'}</span>
              </div>
              <h4 style="margin:4px 0; font-size:16px;">
                ${b.url ? `<a href="${b.url}" target="_blank" rel="noopener" style="color:inherit; text-decoration:none;">${esc(b.title || 'Untitled')}</a>` : esc(b.title || 'Untitled')}
              </h4>
              <div style="font-size:12px; color:var(--muted);">${b.url ? getDomain(b.url) : ''}</div>
              <div class="tags">${(b.tags || []).map(tag => `<span class="tag">${esc(tag)}</span>`).join('')}</div>
              <p style="font-size:13px; color:var(--muted);">${esc((b.notes || '').slice(0, 120))}</p>
              <div class="card-actions">
                <button data-open="${b.id}">Open</button>
                <button data-more="${b.id}">More</button>
              </div>
            </div>
          </div>`;
        panel.appendChild(card);
      });
      $('loadMore').classList.toggle('hidden', filtered.length <= end);
      panel.querySelectorAll('[data-open]').forEach(btn => btn.addEventListener('click', () => openBookmark(btn.dataset.open)));
      panel.querySelectorAll('[data-more]').forEach(btn => btn.addEventListener('click', () => showActionSheet(btn.dataset.more)));
    }

    function renderSnippets() {
      const panel = $('snippetsPanel');
      const list = getFiltered().filter(b => b.snippetContent);
      panel.innerHTML = '';
      if (!list.length) {
        panel.innerHTML = '<p style="text-align:center; color:var(--muted);">No snippets found.</p>';
        return;
      }
      list.forEach(b => {
        const card = document.createElement('div');
        card.className = 'card snippet-card';
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between;">
            <h4>${esc(b.snippetTitle || b.title || 'Snippet')}</h4>
            <span class="badge">${b.folder || 'General'}</span>
          </div>
          <hr />
          <pre>${esc(b.snippetContent)}</pre>`;
        panel.appendChild(card);
      });
    }

    function renderImages() {
      const panel = $('imagesPanel');
      const list = getFiltered().filter(b => b.imageData || b.imageUrl);
      panel.innerHTML = '';
      if (!list.length) {
        panel.innerHTML = '<p style="text-align:center; color:var(--muted);">No images yet.</p>';
        return;
      }
      const grid = document.createElement('div');
      grid.className = 'images-grid';
      list.forEach(b => {
        const card = document.createElement('div');
        card.className = 'card image-card';
        card.innerHTML = `
          <img src="${b.imageData || b.imageUrl}" loading="lazy" alt="${esc(b.imageTitle || b.title || 'Image')}" />
          <h4>${esc(b.imageTitle || b.title || 'Image')}</h4>`;
        grid.appendChild(card);
      });
      panel.appendChild(grid);
    }

    function updateFolderDatalist() {
      const dataList = $('folderList');
      dataList.innerHTML = '';
      Array.from(new Set(state.bookmarks.map(b => b.folder || 'General'))).forEach(folder => {
        const option = document.createElement('option');
        option.value = folder;
        dataList.appendChild(option);
      });
    }

    function updateSearchSuggestions() {
      const list = $('searchSuggestions');
      if (!list) return;
      list.innerHTML = '';
      const seen = new Set();
      const add = (value) => {
        if (!value) return;
        const val = value.toString().trim();
        if (!val) return;
        const key = val.toLowerCase();
        if (seen.has(key) || seen.size >= 40) return;
        seen.add(key);
        const option = document.createElement('option');
        option.value = val;
        list.appendChild(option);
      };
      state.bookmarks.forEach(b => {
        add(b.title);
        add(b.url);
        add(b.folder);
        add((b.notes || '').slice(0, 60));
        add(b.snippetTitle);
        add((b.snippetContent || '').slice(0, 60));
        add(b.imageTitle);
        add((b.imageUrl || '').slice(0, 60));
        (b.tags || []).forEach(add);
      });
      state.suggestions = Array.from(seen);
    }

    function openBookmark(id) {
      const bookmark = state.bookmarks.find(b => b.id === id);
      if (bookmark && bookmark.url) {
        window.open(bookmark.url, '_blank');
      } else {
        toast('No URL');
      }
    }

    function openAddModal() {
      state.editId = null;
      $('modalTitle').textContent = 'Add Bookmark';
      $('bookmarkForm').reset();
      state.imageData = '';
      $('imagePreview').classList.add('hidden');
      openModal('addModal');
    }

    function editBookmark(id) {
      const b = state.bookmarks.find(item => item.id === id);
      if (!b) return;
      state.editId = id;
      $('modalTitle').textContent = 'Edit Bookmark';
      $('urlInput').value = b.url || '';
      $('titleInput').value = b.title || '';
      $('platformSelect').value = b.platform || 'Article';
      $('folderInput').value = b.folder || '';
      $('tagsInput').value = (b.tags || []).join(', ');
      $('notesInput').value = b.notes || '';
      $('snippetTitleInput').value = b.snippetTitle || '';
      $('snippetContentInput').value = b.snippetContent || '';
      $('imageTitleInput').value = b.imageTitle || '';
      $('imageUrlInput').value = b.imageUrl || '';
      state.imageData = b.imageData || '';
      if (state.imageData) {
        $('imagePreview').classList.remove('hidden');
        $('imagePreview').querySelector('img').src = state.imageData;
      } else {
        $('imagePreview').classList.add('hidden');
      }
      openModal('addModal');
    }

    function closeAddModal() {
      closeModal('addModal');
      state.editId = null;
      state.imageData = '';
    }

    function openModal(id) {
      $(id).classList.add('open');
      document.body.classList.add('locked');
    }

    function closeModal(id) {
      $(id).classList.remove('open');
      document.body.classList.remove('locked');
    }

    function saveBookmark() {
      const url = $('urlInput').value.trim();
      const title = $('titleInput').value.trim();
      const platform = $('platformSelect').value || detectPlatform(url);
      const folder = $('folderInput').value.trim() || 'General';
      const tags = $('tagsInput').value.split(',').map(t => t.trim()).filter(Boolean);
      const notes = $('notesInput').value.trim();
      const snippetTitle = $('snippetTitleInput').value.trim();
      const snippetContent = $('snippetContentInput').value.trim();
      const imageTitle = $('imageTitleInput').value.trim();
      const imageUrl = $('imageUrlInput').value.trim();
      const hasContent = url || snippetContent || imageUrl || state.imageData;
      if (!hasContent) {
        toast('Add at least one content type');
        return;
      }
      const now = new Date().toISOString();
      if (state.editId) {
        const idx = state.bookmarks.findIndex(b => b.id === state.editId);
        if (idx > -1) {
          state.bookmarks[idx] = {
            ...state.bookmarks[idx],
            url,
            title: title || state.bookmarks[idx].title || 'Untitled',
            platform,
            folder,
            tags,
            notes,
            snippetTitle,
            snippetContent,
            imageTitle,
            imageUrl,
            imageData: state.imageData,
            updatedAt: now
          };
        }
        toast('Bookmark updated');
      } else {
        state.bookmarks.unshift({
          id: uid(),
          url,
          title: title || (url ? getDomain(url) : snippetTitle || imageTitle || 'Untitled'),
          platform: platform || detectPlatform(url),
          folder,
          tags,
          notes,
          snippetTitle,
          snippetContent,
          imageTitle,
          imageUrl,
          imageData: state.imageData,
          thumbnail: url && detectPlatform(url) === 'YouTube' ? `https://img.youtube.com/vi/${extractYouTubeId(url)}/hqdefault.jpg` : '',
          createdAt: now,
          updatedAt: now
        });
        toast('Bookmark saved');
      }
      saveData();
      render();
      closeAddModal();
    }

    function openSheet(id) {
      $(id).classList.add('open');
      document.body.classList.add('locked');
    }

    function closeAllSheets() {
      document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
      document.body.classList.remove('locked');
    }

    function showActionSheet(id) {
      const b = state.bookmarks.find(x => x.id === id);
      if (!b) return;
      state.selectedId = id;
      $('actionSheetTitle').textContent = b.title || 'Bookmark';
      openSheet('actionSheet');
      document.querySelectorAll('#actionSheet [data-action]').forEach(btn => btn.onclick = () => {
        const action = btn.dataset.action;
        if (action === 'edit') editBookmark(id);
        if (action === 'copy') copyLink(id);
        if (action === 'share') shareBookmark(id);
        if (action === 'delete') deleteBookmark(id);
        closeAllSheets();
      });
    }

    function showFolderSheet() {
      const container = $('folderListSheet');
      container.innerHTML = '';
      const folders = ['All', ...Array.from(new Set(state.bookmarks.map(b => b.folder || 'General'))).sort()];
      folders.forEach(folder => {
        const count = folder === 'All' ? state.bookmarks.length : state.bookmarks.filter(b => (b.folder || 'General') === folder).length;
        const btn = document.createElement('button');
        btn.style.textAlign = 'left';
        btn.textContent = `${folder} (${count})`;
        btn.addEventListener('click', () => {
          state.filter.folder = folder;
          renderContent();
          closeAllSheets();
        });
        container.appendChild(btn);
      });
      openSheet('folderSheet');
    }

    async function fetchMetadata() {
      const url = $('urlInput').value.trim();
      if (!url || $('titleInput').value.trim()) return;
      try {
        if (detectPlatform(url) === 'YouTube') {
          await fetchYouTubeData(url);
        } else {
          const res = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
          if (res.ok) {
            const data = await res.json();
            $('titleInput').value = data.title || $('titleInput').value;
          }
        }
      } catch (err) {
        console.warn('Metadata fetch failed');
      }
    }

    async function fetchYouTubeData(url) {
      const id = extractYouTubeId(url);
      if (!id) return;
      try {
        const res = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
        if (res.ok) {
          const data = await res.json();
          $('titleInput').value = data.title || $('titleInput').value;
          state.imageData = data.thumbnail_url || `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
        } else {
          state.imageData = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
        }
        $('imagePreview').classList.remove('hidden');
        $('imagePreview').querySelector('img').src = state.imageData;
      } catch (err) {
        console.warn('YT fetch error');
      }
    }

    function extractYouTubeId(url) {
      try {
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        if (u.searchParams.get('v')) return u.searchParams.get('v');
        if (u.pathname.includes('/embed/')) return u.pathname.split('/embed/')[1];
        if (u.pathname.includes('/shorts/')) return u.pathname.split('/shorts/')[1];
      } catch (err) {
        return null;
      }
      return null;
    }

    function detectPlatform(url = '') {
      if (!url) return 'Custom';
      const u = url.toLowerCase();
      if (u.includes('youtube.com') || u.includes('youtu.be')) return 'YouTube';
      if (u.includes('twitter.com') || u.includes('x.com')) return 'Tweet';
      if (u.includes('spotify.com') || u.includes('podcast') || u.includes('anchor.fm')) return 'Podcast';
      if (u.includes('medium.com') || u.includes('dev.to') || u.includes('blog')) return 'Article';
      return 'Article';
    }

    function isUrl(str) {
      return /^https?:\/\//i.test(str);
    }

    function getDomain(url) {
      try {
        const { hostname } = new URL(url);
        return hostname.replace('www.', '');
      } catch (err) {
        return url;
      }
    }

    function getFavicon(url) {
      if (!url) return 'https://www.google.com/s2/favicons?domain=example.com&sz=128';
      return `https://www.google.com/s2/favicons?domain=${getDomain(url)}&sz=128`;
    }

    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    function esc(str = '') {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        toast('Invalid image');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        toast('Image too large');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        state.imageData = reader.result;
        $('imagePreview').classList.remove('hidden');
        $('imagePreview').querySelector('img').src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    async function readClipboard() {
      try {
        const text = await navigator.clipboard.readText();
        if (text) {
          state.clipboardContent = text;
          $('clipboardPreview').textContent = text;
          openSheet('clipboardSheet');
        } else {
          showPastePrompt();
        }
      } catch (err) {
        showPastePrompt();
      }
    }

    function showPastePrompt() {
      const overlay = document.createElement('textarea');
      overlay.style.position = 'fixed';
      overlay.style.inset = '20px';
      overlay.style.zIndex = '999';
      overlay.style.padding = '20px';
      overlay.placeholder = 'Paste here...';
      document.body.appendChild(overlay);
      overlay.focus();
      const timer = setTimeout(() => document.body.removeChild(overlay), 10000);
      overlay.addEventListener('input', () => {
        clearTimeout(timer);
        state.clipboardContent = overlay.value;
        $('clipboardPreview').textContent = overlay.value;
        document.body.removeChild(overlay);
        openSheet('clipboardSheet');
      });
    }

    function handleClipAction(action) {
      closeAllSheets();
      openAddModal();
      const text = state.clipboardContent;
      if (action === 'bookmark') {
        if (isUrl(text.trim())) {
          $('urlInput').value = text.trim();
          $('titleInput').value = '';
        } else {
          $('notesInput').value = text;
        }
      }
      if (action === 'snippet') {
        $('snippetContentInput').value = text;
        $('snippetTitleInput').value = 'Clipboard';
      }
      if (action === 'image') {
        $('imageUrlInput').value = text.trim();
      }
      toast('Clipboard captured');
    }

    function copyLink(id) {
      const b = state.bookmarks.find(item => item.id === id);
      if (!b || !b.url) {
        toast('No URL to copy');
        return;
      }
      copyText(b.url);
      toast('Link copied');
    }

    async function shareBookmark(id) {
      const b = state.bookmarks.find(item => item.id === id);
      if (!b) return;
      if (navigator.share) {
        try {
          await navigator.share({ title: b.title, text: b.notes, url: b.url });
        } catch (err) {
          console.warn('Share cancelled');
        }
      } else {
        copyLink(id);
      }
    }

    function deleteBookmark(id) {
      if (!confirm('Delete bookmark?')) return;
      if (!confirm('This cannot be undone. Delete?')) return;
      state.bookmarks = state.bookmarks.filter(b => b.id !== id);
      saveData();
      render();
      toast('Bookmark deleted');
    }

    function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
      }
    }

    function applyTheme() {
      document.body.classList.toggle('dark', state.theme === 'dark');
      $('themeLabel').textContent = state.theme === 'dark' ? 'Dark' : 'Light';
      $('themeColorMeta').setAttribute('content', state.theme === 'dark' ? '#0f172a' : '#f59e0b');
    }

    function setTheme(theme) {
      state.theme = theme;
      applyTheme();
      saveData();
      toast(`Theme set to ${theme}`);
      closeAllSheets();
    }

    function exportData() {
      const blob = new Blob([JSON.stringify({ bookmarks: state.bookmarks }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bookmark-vault.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast('Data exported');
    }

    function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data.bookmarks)) throw new Error('Invalid file');
          const replace = confirm('Replace existing data? OK = replace, Cancel = merge');
          if (replace) {
            state.bookmarks = data.bookmarks;
          } else {
            const map = new Map(state.bookmarks.map(b => [b.id, b]));
            data.bookmarks.forEach(b => map.set(b.id || uid(), { ...b, id: b.id || uid() }));
            state.bookmarks = Array.from(map.values());
          }
          saveData();
          render();
          toast('Import complete');
        } catch (err) {
          toast('Import failed');
        }
      };
      reader.readAsText(file);
    }

    function clearAllData() {
      if (!confirm('Clear all data?')) return;
      if (!confirm('This cannot be undone. Continue?')) return;
      state.bookmarks = [];
      saveData();
      render();
      toast('Data cleared');
    }

    async function pullGitHub() {
      const { owner, repo, path, token } = state.github;
      if (!owner || !repo || !path) {
        toast('Missing GitHub info');
        return;
      }
      $('githubStatus').textContent = 'Pulling...';
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        if (!res.ok) throw new Error('GitHub error');
        const data = await res.json();
        state.github.sha = data.sha;
        const decoded = atob(data.content.replace(/\n/g, ''));
        const json = JSON.parse(decoded);
        if (Array.isArray(json.bookmarks)) {
          state.bookmarks = json.bookmarks;
          saveData();
          render();
          $('githubStatus').textContent = 'Pulled at ' + new Date().toLocaleTimeString();
          toast('GitHub pull complete');
        }
      } catch (err) {
        $('githubStatus').textContent = 'Pull failed';
        toast('GitHub pull failed');
      }
    }

    async function pushGitHub() {
      const { owner, repo, path, token, sha } = state.github;
      if (!owner || !repo || !path || !token) {
        toast('Missing GitHub info');
        return;
      }
      $('githubStatus').textContent = 'Pushing...';
      try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify({ bookmarks: state.bookmarks }, null, 2))));
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Update bookmarks',
            content,
            sha: sha || undefined
          })
        });
        if (!res.ok) throw new Error('GitHub error');
        const data = await res.json();
        state.github.sha = data.content.sha;
        saveData();
        $('githubStatus').textContent = 'Pushed at ' + new Date().toLocaleTimeString();
        toast('GitHub push complete');
      } catch (err) {
        $('githubStatus').textContent = 'Push failed';
        toast('GitHub push failed');
      }
    }

    function toast(message, duration = 2500) {
      const el = $('toast');
      el.textContent = message;
      el.classList.add('show');
      if (navigator.vibrate) navigator.vibrate(10);
      clearTimeout(el._timer);
      el._timer = setTimeout(() => el.classList.remove('show'), duration);
    }

    function setupPWA() {
      if ('serviceWorker' in navigator) {
        const swCode = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',()=>{});`;
        const blob = new Blob([swCode], { type: 'text/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl);
      }
      const manifest = {
        name: "Mani's Bookmark Vault",
        short_name: 'Bookmarks',
        description: 'Mobile-first bookmark manager',
        start_url: location.origin + location.pathname,
        display: 'standalone',
        orientation: 'portrait',
        background_color: '#ffffff',
        theme_color: '#f59e0b',
        icons: [{
          src: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='24' fill='%23f59e0b'/><path d='M64 26l28 18v58l-28-18-28 18V44z' fill='white'/></svg>`,
          sizes: 'any',
          type: 'image/svg+xml',
          purpose: 'any maskable'
        }],
        share_target: {
          action: location.href,
          method: 'GET',
          params: { title: 'title', text: 'text', url: 'url' }
        }
      };
      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manifestURL;
      document.head.appendChild(link);
    }

    function checkShareTarget() {
      const params = new URLSearchParams(location.search);
      const url = params.get('url');
      const text = params.get('text');
      const title = params.get('title');
      if (url || text) {
        openAddModal();
        if (url) $('urlInput').value = url;
        if (title) $('titleInput').value = title;
        if (text) $('notesInput').value = text;
        toast('Shared content ready');
        history.replaceState({}, document.title, location.pathname);
      }
    }

    async function installPWA() {
      if (!state.deferredPrompt) return;
      state.deferredPrompt.prompt();
      const choice = await state.deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        toast('Installing...');
      }
      state.deferredPrompt = null;
      $('installBtn').disabled = true;
    }
  </script>
</body>
</html>
